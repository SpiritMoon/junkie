// -*- c-basic-offset: 4; c-backslash-column: 79; indent-tabs-mode: nil -*-
// vim:sw=4 ts=4 sts=4 expandtab
#include <stdlib.h>
#undef NDEBUG
#include <assert.h>
#include <time.h>
#include <junkie/cpp.h>
#include <junkie/tools/ext.h>
#include <junkie/tools/objalloc.h>
#include <junkie/proto/cursor.h>
#include <junkie/proto/tcp.h>
#include <junkie/proto/ip.h>
#include <junkie/proto/eth.h>
#include <junkie/proto/pkt_wait_list.h>
#include "lib.h"
#include "proto/tds.c"
#include "proto/tds_msg.c"
#include "sql_test.h"


static struct parse_test {
    uint8_t const *packet;
    int size;
    int cap_len;
    enum proto_parse_status ret;         // Expected proto status
    struct sql_proto_info expected;
    enum way way;
    bool called;
} parse_tests[] = {

    // First prelogin
    {
        .packet = (uint8_t const []) {
//          Prel Stat Length--- Chan----- PktN Wind  TokV offset--- length--- Encr offset---
            0x12,0x01,0x00,0x43,0x00,0x00,0x00,0x00, 0x00,0x00,0x10,0x00,0x06,0x01,0x00,0x16,
//          Length--- Trac offset--- length--- Term  Version---------------------- Encr Trac
            0x00,0x01,0x05,0x00,0x17,0x00,0x24,0xff, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,
//          --------------------------------------------------------------------------------
            0x52,0x77,0xdd,0xe8,0xbc,0x2e,0x4e,0xb1, 0xb7,0xcf,0x10,0xdc,0xdf,0x37,0xeb,0x2b,
//          --------------------------------------------------------------------------------
            0xb9,0xc6,0x21,0x2f,0x0e,0xf6,0x4f,0xad, 0x02,0x9a,0xec,0xd4,0x2a,0x82,0xbb,0x01,
//          --------------
            0x00,0x00,0x00
        },
        .size = 0x43,
        .cap_len = 0x43,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0x43 - 8, .payload = 0},
            .set_values = SQL_VERSION,
            .version_maj = 0,
            .version_min = 0,
            .msg_type = SQL_STARTUP,
        },
        .called = true,
    },

    // Server response to first prelogin
    {
        .packet = (uint8_t const []) {
//          Resp Stat Length--- Chan----- Pktn Wind  TokV offset--- Length--- Encr offset---
            0x04,0x01,0x00,0x1f,0x00,0x00,0x01,0x00, 0x00,0x00,0x10,0x00,0x06,0x01,0x00,0x16,
//          Length--- Trac offset--- Length--- Term  Version---------------------- Encr
            0x00,0x01,0x05,0x00,0x17,0x00,0x00,0xff, 0x0b,0x00,0x0c,0x38,0x00,0x00,0x00
        },
        .size = 0x1f,
        .cap_len = 0x1f,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = 0x1f - 8, .payload = 0},
            .set_values = SQL_VERSION,
            .version_maj = 11,
            .version_min = 0,
            .msg_type = SQL_STARTUP,
        },
        .called = true,
    },

    // Second prelogin. Looks like an ssl handshake...
    {
        .packet = (uint8_t const []) {
//          Prel Stat Length--- Chan----- Pktn Wind  Tok
            0x12,0x01,0x00,0xa2,0x00,0x00,0x01,0x00, 0x16,0x03,0x01,0x00,0x95,0x01,0x00,0x00,
            0x91,0x03,0x01,0x52,0xe7,0xb4,0x0d,0x0b, 0x58,0x4f,0x28,0x95,0x6d,0x4a,0xe7,0xb0,
            0x7e,0xf1,0x2a,0xb1,0x97,0x63,0xaf,0x7c, 0xfd,0x2b,0x42,0x76,0x4b,0xa0,0x01,0x05,
            0x4e,0xec,0x9c,0x00,0x00,0x2a,0xc0,0x09, 0xc0,0x13,0x00,0x2f,0xc0,0x04,0xc0,0x0e,
            0x00,0x33,0x00,0x32,0xc0,0x07,0xc0,0x11, 0x00,0x05,0xc0,0x02,0xc0,0x0c,0xc0,0x08,
            0xc0,0x12,0x00,0x0a,0xc0,0x03,0xc0,0x0d, 0x00,0x16,0x00,0x13,0x00,0x04,0x00,0xff,
            0x01,0x00,0x00,0x3e,0x00,0x0a,0x00,0x34, 0x00,0x32,0x00,0x17,0x00,0x01,0x00,0x03,
            0x00,0x13,0x00,0x15,0x00,0x06,0x00,0x07, 0x00,0x09,0x00,0x0a,0x00,0x18,0x00,0x0b,
            0x00,0x0c,0x00,0x19,0x00,0x0d,0x00,0x0e, 0x00,0x0f,0x00,0x10,0x00,0x11,0x00,0x02,
            0x00,0x12,0x00,0x04,0x00,0x05,0x00,0x14, 0x00,0x08,0x00,0x16,0x00,0x0b,0x00,0x02,
            0x01,0x00
        },
        .size = 0xa2,
        .cap_len = 0xa2,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0xa2 - 8, .payload = 0},
            .msg_type = SQL_STARTUP,
        },
        .called = true,
    },

    // Encrypted login... yeah
    {
        .packet = (uint8_t const []) {
            0x17,0x03,0x01,0x01,0x40,0x97,0x72,0xb7, 0x38,0x19,0x81,0x3e,0xa5,0x72,0x20,0xff,
            0xce,0x3b,0x1c,0x10,0x8b,0x94,0x43,0x8b, 0x1e,0xd5,0x64,0x86,0x8a,0x0c,0x5e,0x7b,
            0x96,0x41,0x8a,0x98,0x35,0xb7,0xa4,0x25, 0x23,0x3a,0xb5,0xd8,0x4e,0x18,0xec,0xd8,
            0x59,0x53,0x9a,0x4f,0xb6,0xa7,0x50,0xfa, 0xb0,0x08,0x01,0x4a,0xc3,0x65,0xc6,0x9a,
            0x84,0x38,0x21,0xca,0x6d,0xc0,0xd1,0xb9, 0x2d,0x72,0x83,0x7d,0x2b,0x6f,0x79,0x65,
            0x6a,0x29,0x6b,0x1e,0x2f,0xf8,0x95,0xfc, 0x47,0xf6,0x4f,0xbe,0xff,0x8d,0x37,0xf5,
            0x84,0x59,0xa5,0x80,0xbe,0xe5,0x24,0xbe, 0x17,0x5c,0x37,0x1e,0xa2,0x1a,0x45,0xe7,
            0x13,0x7c,0x05,0x80,0x6a,0x26,0xe9,0xb5, 0x84,0xcc,0xbd,0xae,0x7b,0x6f,0xe3,0xa1,
            0xfa,0x28,0x0b,0x7e,0x32,0x94,0x87,0xd1, 0x6e,0xf5,0x47,0xe8,0x9e,0xf0,0x80,0xbf,
            0x3b,0x87,0x34,0x55,0x0d,0x77,0x53,0x27, 0x70,0xda,0x36,0x7e,0xab,0xe3,0xeb,0x66,
            0x07,0xfe,0x7b,0xef,0x1d,0x3a,0x75,0xe8, 0x33,0x22,0xaa,0x98,0x06,0xb9,0xbb,0xf2,
            0xd1,0x7a,0x83,0xbe,0xb6,0x32,0x60,0x9d, 0xb8,0xc3,0x25,0xb8,0x54,0x91,0x47,0x7c,
            0x2c,0x96,0xf6,0x4a,0x13,0x6b,0x91,0xa4, 0xfd,0xfd,0x49,0x12,0x81,0x2b,0xa3,0xf2,
            0xeb,0x23,0xb3,0x21,0x5f,0xa0,0xc1,0x78, 0xd1,0x90,0x91,0x44,0xf0,0x20,0x61,0x1f,
            0xea,0xa7,0x37,0x69,0x7e,0xde,0x0c,0xec, 0x13,0x3a,0x0e,0x75,0x51,0xfb,0x98,0xff,
            0x3e,0x2b,0x2a,0xcb,0x5f,0xe2,0x8a,0x1d, 0x66,0xb1,0x71,0x79,0xf0,0x79,0x81,0x3a,
            0xa3
        },
        .size = 0x145,
        .cap_len = 0x145,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0x145 - 8, .payload = 0},
            .msg_type = SQL_STARTUP,
        },
        .called = false,
    },

    // Login response
    {
        .packet = (uint8_t const []) {
//          Resp Stat Length--- Channel-- Pack Wind  EnvC Size----- Type vLen NewValue------
            0x04,0x01,0x01,0x99,0x00,0x33,0x01,0x00, 0xe3,0x17,0x00,0x01,0x04,0x6f,0x00,0x63,
//          ------------------------ vLen OldValue------------------------------------------
            0x00,0x74,0x00,0x6f,0x00,0x06,0x6d,0x00, 0x61,0x00,0x73,0x00,0x74,0x00,0x65,0x00,
//          --------- Info Size----- ErrorCode----------- Stat Seve Len------ Message-------
            0x72,0x00,0xab,0x76,0x00,0x45,0x16,0x00, 0x00,0x02,0x00,0x23,0x00,0x43,0x00,0x68,
//          --------------------------------------------------------------------------------
            0x00,0x61,0x00,0x6e,0x00,0x67,0x00,0x65, 0x00,0x64,0x00,0x20,0x00,0x64,0x00,0x61,
//          --------------------------------------------------------------------------------
            0x00,0x74,0x00,0x61,0x00,0x62,0x00,0x61, 0x00,0x73,0x00,0x65,0x00,0x20,0x00,0x63,
//          --------------------------------------------------------------------------------
            0x00,0x6f,0x00,0x6e,0x00,0x74,0x00,0x65, 0x00,0x78,0x00,0x74,0x00,0x20,0x00,0x74,
//          --------------------------------------------------------------------------------
            0x00,0x6f,0x00,0x20,0x00,0x27,0x00,0x6f, 0x00,0x63,0x00,0x74,0x00,0x6f,0x00,0x27,
//          -------------- Leng ServerName--------------------------------------------------
            0x00,0x2e,0x00,0x12,0x49,0x00,0x45,0x00, 0x39,0x00,0x57,0x00,0x49,0x00,0x4e,0x00,
//          --------------------------------------------------------------------------------
            0x37,0x00,0x5c,0x00,0x53,0x00,0x51,0x00, 0x4c,0x00,0x45,0x00,0x58,0x00,0x50,0x00,
//          ---------------------------------------  Proc LineNumbe EnvC Length--- Type OldV
            0x52,0x00,0x45,0x00,0x53,0x00,0x53,0x00, 0x00,0x01,0x00,0xe3,0x08,0x00,0x07,0x05,
//          ------------------------ Size EnvC Length---- Type OldV ------------------------
            0x09,0x04,0xd0,0x00,0x34,0x00,0xe3,0x17, 0x00,0x02,0x0a,0x75,0x00,0x73,0x00,0x5f,
//          --------------------------------------------------------------------------- OldV
            0x00,0x65,0x00,0x6e,0x00,0x67,0x00,0x6c, 0x00,0x69,0x00,0x73,0x00,0x68,0x00,0x00,
//          Info Leng----- InfoValue--------------------------------------------------------
            0xab,0x7e,0x00,0x47,0x16,0x00,0x00,0x01, 0x00,0x27,0x00,0x43,0x00,0x68,0x00,0x61,
//          --------------------------------------------------------------------------------
            0x00,0x6e,0x00,0x67,0x00,0x65,0x00,0x64, 0x00,0x20,0x00,0x6c,0x00,0x61,0x00,0x6e,
//          --------------------------------------------------------------------------------
            0x00,0x67,0x00,0x75,0x00,0x61,0x00,0x67, 0x00,0x65,0x00,0x20,0x00,0x73,0x00,0x65,
//          --------------------------------------------------------------------------------
            0x00,0x74,0x00,0x74,0x00,0x69,0x00,0x6e, 0x00,0x67,0x00,0x20,0x00,0x74,0x00,0x6f,
//          --------------------------------------------------------------------------------
            0x00,0x20,0x00,0x75,0x00,0x73,0x00,0x5f, 0x00,0x65,0x00,0x6e,0x00,0x67,0x00,0x6c,
//          --------------------------------------------------------------------------------
            0x00,0x69,0x00,0x73,0x00,0x68,0x00,0x2e, 0x00,0x12,0x49,0x00,0x45,0x00,0x39,0x00,
//          --------------------------------------------------------------------------------
            0x57,0x00,0x49,0x00,0x4e,0x00,0x37,0x00, 0x5c,0x00,0x53,0x00,0x51,0x00,0x4c,0x00,
//          --------------------------------------------------------------------------------
            0x45,0x00,0x58,0x00,0x50,0x00,0x52,0x00, 0x45,0x00,0x53,0x00,0x53,0x00,0x00,0x01,
//          ---- LogA Length--- Inte TDSVersion---------- Prog -----------------------------
            0x00,0xad,0x36,0x00,0x01,0x71,0x00,0x00, 0x01,0x16,0x4d,0x00,0x69,0x00,0x63,0x00,
//          --------------------------------------------------------------------------------
            0x72,0x00,0x6f,0x00,0x73,0x00,0x6f,0x00, 0x66,0x00,0x74,0x00,0x20,0x00,0x53,0x00,
//          --------------------------------------------------------------------------------
            0x51,0x00,0x4c,0x00,0x20,0x00,0x53,0x00, 0x65,0x00,0x72,0x00,0x76,0x00,0x65,0x00,
//          ----------------------------- ProgVersion--------- EnvC
            0x72,0x00,0x00,0x00,0x00,0x00,0x0b,0x00, 0x0c,0x38,0xe3,0x13,0x00,0x04,0x04,0x34,
            0x00,0x30,0x00,0x39,0x00,0x36,0x00,0x04, 0x34,0x00,0x30,0x00,0x39,0x00,0x36,0x00,
            0xfd,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00
        },
        .size = 0x199,
        .cap_len = 0x199,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0x199 - 8, .payload = 0},
            .msg_type = SQL_STARTUP,
            .set_values = SQL_DBNAME | SQL_VERSION | SQL_REQUEST_STATUS,
            .request_status = SQL_REQUEST_COMPLETE,
            .version_maj = 7,
            .version_min = 1,
            .u = { .startup = { .dbname = "octo" } },
        },
        .called = true,
    },

    // A select
    {
        .packet = (uint8_t const []) {
//          RPC  stat Length--- -------------------
            0x03,0x01,0x00,0x69,0x00,0x33,0x01,0x00, 0x16,0x00,0x00,0x00,0x12,0x00,0x00,0x00,
            0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x01,0x00,0x00,0x00,0xff,0xff,
            0x0d,0x00,0x00,0x00,0x00,0x01,0x26,0x04, 0x04,0x00,0x00,0x00,0x00,0x00,0x00,0xe7,
            0x40,0x1f,0x09,0x04,0xd0,0x00,0x34,0xff, 0xff,0x00,0x00,0xe7,0x40,0x1f,0x09,0x04,
            0xd0,0x00,0x34,0x24,0x00,0x53,0x00,0x45, 0x00,0x4c,0x00,0x45,0x00,0x43,0x00,0x54,
            0x00,0x20,0x00,0x2a,0x00,0x20,0x00,0x46, 0x00,0x52,0x00,0x4f,0x00,0x4d,0x00,0x20,
            0x00,0x54,0x00,0x6f,0x00,0x74,0x00,0x6f, 0x00
        },
        .size = 0x69,
        .cap_len = 0x69,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0x69 - 8, .payload = 0},
            .set_values = SQL_SQL,
            .u = { .query = { .sql = "PrepExec(0,NULL,SELECT * FROM Toto)", .truncated=false } },
            .msg_type = SQL_QUERY,
        },
        .called = true,
    },

    // An rpc with xml
    {
        .packet = (uint8_t const []) {
//          RPC  stat length--- -------------------  All-headers----------------------------
            0x03,0x01,0x00,0xc7,0x00,0x33,0x01,0x00, 0x16,0x00,0x00,0x00,0x12,0x00,0x00,0x00,
//          ---------------------------------------------------------------------- NameLenPr
            0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x01,0x00,0x00,0x00,0xff,0xff,
//          PrepExec----------- bVar Stat IntT Leng  Leng ------------------- bVar Stat NVar
            0x0d,0x00,0x00,0x00,0x00,0x01,0x26,0x04, 0x04,0x00,0x00,0x00,0x00,0x00,0x00,0xe7,
//          --------- Collation--------------- Size  --------@---------P---------0---------
            0x40,0x1f,0x09,0x04,0xd0,0x00,0x34,0x0e, 0x00,0x40,0x00,0x50,0x00,0x30,0x00,0x20,
//          --------x---------m---------l----- bVar  Stat NVar---------- Collation----------
            0x00,0x78,0x00,0x6d,0x00,0x6c,0x00,0x00, 0x00,0xe7,0x40,0x1f,0x09,0x04,0xd0,0x00,
//          ---- Size ----------------------------------------------------------------------
            0x34,0x36,0x00,0x45,0x00,0x58,0x00,0x45, 0x00,0x43,0x00,0x20,0x00,0x53,0x00,0x61,
//          --------------------------------------------------------------------------------
            0x00,0x6d,0x00,0x70,0x00,0x6c,0x00,0x65, 0x00,0x50,0x00,0x72,0x00,0x6f,0x00,0x63,
//          --------------------------------------------------------------------------------
            0x00,0x20,0x00,0x40,0x00,0x50,0x00,0x30, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//          --------------------------------------------- bVar Stat XMLType-- Unknonw Length
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x00,0x00,0xf1,0x00,0xfe,0xff,0xff,
//          ------------------------ ChunkSize-----------
            0xff,0xff,0xff,0xff,0xff,0x2a,0x00,0x00, 0x00,0x3c,0x00,0x72,0x00,0x6f,0x00,0x6f,
            0x00,0x74,0x00,0x3e,0x00,0x3c,0x00,0x74, 0x00,0x6f,0x00,0x74,0x00,0x6f,0x00,0x31,
            0x00,0x2f,0x00,0x3e,0x00,0x3c,0x00,0x2f, 0x00,0x72,0x00,0x6f,0x00,0x6f,0x00,0x74,
            0x00,0x3e,0x00,0x00,0x00,0x00,0x00
        },
        .size = 0xc7,
        .cap_len = 0xc7,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0xc7 - 0x8, .payload = 0x0},
            .set_values = SQL_SQL,
            .u = { .query = { .sql = "PrepExec(0,@P0 xml,EXEC SampleProc @P0        ,<root><toto1/></root>)", .truncated=false } },
            .msg_type = SQL_QUERY,
        },
        .called = true,
    },

    // First part long query
    {
        .packet = (uint8_t const []) {
//          RPC  stat Length--- -------------------  ProcName--ProcName- flags---- Name Status
            0x03,0x01,0x01,0x3e,0x00,0x00,0x01,0x00, 0xff,0xff,0x0b,0x00,0x00,0x00,0x00,0x01,
//          Token 0x26 == IntNType -> Length == 1, VarL is useless...
//          Tok  VarL Size Name Stat Toke VarL-----  Collation--------------- Size----- Name
            0x26,0x04,0x00,0x00,0x00,0xe7,0x40,0x1f, 0x09,0x04,0xd0,0x00,0x34,0x00,0x00,0x00,
//          Stat Toke VarL----- Collation---------------- Size----- {
            0x00,0xe7,0x40,0x1f,0x09,0x04,0xd0,0x00, 0x34,0x0a,0x01,0x53,0x00,0x45,0x00,0x4c,
            0x00,0x45,0x00,0x43,0x00,0x54,0x00,0x20, 0x00,0x2a,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20
        },
        .size = 0x98,
        .cap_len = 0x98,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .called = false,
    },

    // Second part long query
    {
        .packet = (uint8_t const []) {
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
            0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x46,0x00,0x52,0x00,0x4f,
            0x00,0x4d,0x00,0x20,0x00,0x54,0x00,0x6f, 0x00,0x74,0x00,0x6f,0x00,0x00,0x00,0x26,
            0x04,0x04,0x01,0x00,0x00,0x00
        },
        .size = 0xa6,
        .cap_len = 0xa6,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = 0x13e - 8, .payload = 0},
            .set_values = SQL_SQL,
            .msg_type = SQL_QUERY,
            .u = { .query = { .sql = "Prepare(NULL,NULL,SELECT *                                                                                                                    FROM Toto,1)" , .truncated=false} } ,
        },
        .called = true,
    },

      // An insert
      {
          .packet = (uint8_t const []) {
              0x03,0x01,0x00,0xdf,0x00,0x33,0x01,0x00, 0x16,0x00,0x00,0x00,0x12,0x00,0x00,0x00,
              0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x01,0x00,0x00,0x00,0xff,0xff,
              0x0d,0x00,0x00,0x00,0x00,0x01,0x26,0x04, 0x04,0x00,0x00,0x00,0x00,0x00,0x00,0xe7,
              0x40,0x1f,0x09,0x04,0xd0,0x00,0x34,0x24, 0x00,0x40,0x00,0x50,0x00,0x30,0x00,0x20,
              0x00,0x6e,0x00,0x76,0x00,0x61,0x00,0x72, 0x00,0x63,0x00,0x68,0x00,0x61,0x00,0x72,
              0x00,0x28,0x00,0x34,0x00,0x30,0x00,0x30, 0x00,0x30,0x00,0x29,0x00,0x00,0x00,0xe7,
              0x40,0x1f,0x09,0x04,0xd0,0x00,0x34,0x5a, 0x00,0x49,0x00,0x4e,0x00,0x53,0x00,0x45,
              0x00,0x52,0x00,0x54,0x00,0x20,0x00,0x49, 0x00,0x4e,0x00,0x54,0x00,0x4f,0x00,0x20,
              0x00,0x54,0x00,0x6f,0x00,0x74,0x00,0x6f, 0x00,0x20,0x00,0x28,0x00,0x6e,0x00,0x61,
              0x00,0x6d,0x00,0x65,0x00,0x29,0x00,0x20, 0x00,0x56,0x00,0x41,0x00,0x4c,0x00,0x55,
              0x00,0x45,0x00,0x53,0x00,0x20,0x00,0x28, 0x00,0x40,0x00,0x50,0x00,0x30,0x00,0x29,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x00,0x00,0xe7,0x40,0x1f, 0x09,0x04,0xd0,0x00,0x34,0x10,0x00,0x61,
              0x00,0x6e,0x00,0x6f,0x00,0x74,0x00,0x68, 0x00,0x65,0x00,0x72,0x00,0x32,0x00
          },
          .size = 0xdf,
          .cap_len = 0xdf,
          .ret = PROTO_OK,
          .way = FROM_CLIENT,
          .expected = {
              .info = { .head_len = 0xdf - 8, .payload = 0},
              .set_values = SQL_SQL,
              .msg_type = SQL_QUERY,
              .u = { .query = { .sql = "PrepExec(0,@P0 nvarchar(4000),INSERT INTO Toto (name) VALUES (@P0)         ,another2)", .truncated=false } },
          },
        .called = true,
      },

      // A response packet
      {
          .packet = (uint8_t const []) {
//            Resp Stat Length--- Channel-- Pack Wind  Done MsgStatus curCmd--- DoneRowCount-
              0x04,0x01,0x00,0x39,0x00,0x33,0x01,0x00, 0xff,0x11,0x00,0xc3,0x00,0x01,0x00,0x00,
//            ------------------------ RetS -------------------- RetV Ordinal--
              0x00,0x00,0x00,0x00,0x00,0x79,0x00,0x00, 0x00,0x00,0xac,0x00,0x00,0x00,0x01,0x00,
              0x00,0x00,0x00,0x00,0x00,0x26,0x04,0x04, 0x01,0x00,0x00,0x00,0xfe,0x00,0x00,0xe0,
              0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00
          },
          .size = 0x39,
          .cap_len = 0x39,
          .ret = PROTO_OK,
          .way = FROM_SERVER,
          .expected = {
              .info = { .head_len = 0x39 - 8, .payload = 0},
              .set_values = SQL_NB_ROWS | SQL_REQUEST_STATUS,
              .request_status = SQL_REQUEST_COMPLETE,
              .u = { .query = { .nb_rows = 1 } },
              .msg_type = SQL_QUERY,
          },
        .called = true,
      },

      // Splitted packet First
      {
          .packet = (uint8_t const []) {
              0x03,0x00,0x02,0x00,0x00,0x33,0x01,0x00, 0x16,0x00,0x00,0x00,0x12,0x00,0x00,0x00,
              0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x01,0x00,0x00,0x00,0xff,0xff,
              0x0d,0x00,0x00,0x00,0x00,0x01,0x26,0x04, 0x04,0x00,0x00,0x00,0x00,0x00,0x00,0xe7,
              0x40,0x1f,0x09,0x04,0xd0,0x00,0x34,0xff, 0xff,0x00,0x00,0xe7,0x40,0x1f,0x09,0x04,
              0xd0,0x00,0x34,0x04,0x02,0x53,0x00,0x45, 0x00,0x4c,0x00,0x45,0x00,0x43,0x00,0x54,
              0x00,0x20,0x00,0x2a,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
          },
          .size = 0x200,
          .cap_len = 0x200,
          .ret = PROTO_OK,
          .way = FROM_SERVER,
          // Only tds header is advertised here
          .called = true,
      },

      // Splitted packet First
      {
          .packet = (uint8_t const []) {
              0x03,0x01,0x00,0x51,0x00,0x33,0x02,0x00, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
              0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x46,
              0x00,0x52,0x00,0x4f,0x00,0x4d,0x00,0x20, 0x00,0x54,0x00,0x6f,0x00,0x74,0x00,0x6f,
              0x00
          },
          .size = 0x51,
          .cap_len = 0x51,
          .ret = PROTO_OK,
          .way = FROM_SERVER,
          .expected = {
              // We have 2 headers here since tds msg has been transported by two tds pdu
              .info = { .head_len = 0x251 - 8 - 8, .payload = 0},
              .set_values = SQL_SQL,
              .u = { .query = { .sql = "PrepExec(0,NULL,SELECT *                                                                                                                                                                                                                                                 FROM Toto)", .truncated=false } },
              .msg_type = SQL_QUERY,
          },
          .called = true,
      },

     // A select response with two row
     {
         .packet = (uint8_t const []) {
//           Resp Stat Length--- osef---------------  ColM Count---- UserType----------- Flag
             0x04,0x01,0x00,0x9b,0x00,0x33,0x01,0x00, 0x81,0x02,0x00,0x00,0x00,0x00,0x00,0x08,
//           ---- Toke VarL Size Varchar-(guid)-------------------------- UserType-----------
             0x00,0x24,0x10,0x04,0x67,0x00,0x75,0x00, 0x69,0x00,0x64,0x00,0x00,0x00,0x00,0x00,
//           Flag----- Toke VarL----- Collation---------------- Size VarChar-(name)----------
             0x09,0x00,0xa7,0x28,0x00,0x09,0x04,0xd0, 0x00,0x34,0x04,0x6e,0x00,0x61,0x00,0x6d,
//           -------------- ROW1 Size Guid1--------------------------------------------------
             0x00,0x65,0x00,0xd1,0x10,0x7e,0x31,0xc2, 0xd0,0x88,0x6d,0x11,0xe3,0xad,0x79,0x08,
//           ------------------------ Size----- Name1 (another)-------------------- ROW2 Size
             0x00,0x27,0xc3,0x76,0xdc,0x07,0x00,0x61, 0x6e,0x6f,0x74,0x68,0x65,0x72,0xd1,0x10,
//           Guid2---------------------------------------------------------------------------
             0x87,0x22,0x94,0x50,0x88,0x6d,0x11,0xe3, 0xad,0x79,0x08,0x00,0x27,0xc3,0x76,0xdc,
//           Size----- Name2-(another2)------------------------ DONE Status--- CurCmd--- Done-
             0x08,0x00,0x61,0x6e,0x6f,0x74,0x68,0x65, 0x72,0x32,0xff,0x11,0x00,0xc1,0x00,0x02,
//           RowCount-------------------------- RSTA  Status------------- RVAL ordinal-- varc
             0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x79, 0x00,0x00,0x00,0x00,0xac,0x00,0x00,0x00,
//           Stat UserType----------- Flags---- Type  VarL Size Valu--------------- DONP Stat
             0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x26, 0x04,0x04,0x01,0x00,0x00,0x00,0xfe,0x00,
//           ---- CurCmd--- DonwRow---------------------------------
             0x00,0xe0,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00
         },
         .size = 0x9b,
         .cap_len = 0x9b,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x9b - 8, .payload = 0},
             .request_status = SQL_REQUEST_COMPLETE,
             .set_values = SQL_NB_ROWS | SQL_NB_FIELDS | SQL_REQUEST_STATUS,
             .u = { .query = { .nb_rows = 2, .nb_fields = 2 } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // A select response with one row
     {
         .packet = (uint8_t const []) {
//           Resp Stat Length--- osef---------------  ColM Count---- UserType----------- Flag
             0x04,0x01,0x00,0x7f,0x00,0x33,0x01,0x00, 0x81,0x02,0x00,0x00,0x00,0x00,0x00,0x08,
//           ---- Toke VarL Size VarChar-(guid)-------------------------- UserType-----------
             0x00,0x24,0x10,0x04,0x67,0x00,0x75,0x00, 0x69,0x00,0x64,0x00,0x00,0x00,0x00,0x00,
//           Flag----- Toke VarL----- Collation----------------
             0x09,0x00,0xa7,0x28,0x00,0x09,0x04,0xd0, 0x00,0x34,0x04,0x6e,0x00,0x61,0x00,0x6d,
             0x00,0x65,0x00,0xd1,0x10,0x7e,0x31,0xc2, 0xd0,0x88,0x6d,0x11,0xe3,0xad,0x79,0x08,
             0x00,0x27,0xc3,0x76,0xdc,0x07,0x00,0x61, 0x6e,0x6f,0x74,0x68,0x65,0x72,0xff,0x11,
             0x00,0xc1,0x00,0x01,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x79,0x00,0x00,0x00,0x00,
             0xac,0x00,0x00,0x00,0x01,0x00,0x00,0x00, 0x00,0x00,0x00,0x26,0x04,0x04,0x01,0x00,
             0x00,0x00,0xfe,0x00,0x00,0xe0,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,
         },
         .size = 0x7f,
         .cap_len = 0x7f,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x7f - 8, .payload = 0},
             .request_status = SQL_REQUEST_COMPLETE,
             .set_values = SQL_NB_ROWS | SQL_NB_FIELDS | SQL_REQUEST_STATUS,
             .u = { .query = { .nb_rows = 1, .nb_fields = 2 } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // An error pdu
     {
         .packet = (uint8_t const []) {
//           RESP Stat Length--- osef---------------  ERR- Length--- Error-Number------- Stat
             0x04,0x01,0x01,0x10,0x00,0x33,0x01,0x00, 0xaa,0x6a,0x00,0xd0,0x00,0x00,0x00,0x01,
//           Clas MsgSize-- MsgContent-------------------------------------------------------
             0x10,0x1c,0x00,0x49,0x00,0x6e,0x00,0x76, 0x00,0x61,0x00,0x6c,0x00,0x69,0x00,0x64,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x6f,0x00,0x62,0x00,0x6a, 0x00,0x65,0x00,0x63,0x00,0x74,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x6e,0x00,0x61,0x00,0x6d,0x00,0x65, 0x00,0x20,0x00,0x27,0x00,0x54,0x00,0x6f,
//           ------------------------------------------------------- Size-ServerName---------
             0x00,0x74,0x00,0x6f,0x00,0x32,0x00,0x27, 0x00,0x2e,0x00,0x12,0x49,0x00,0x45,0x00,
//           --------------------------------------------------------------------------------
             0x39,0x00,0x57,0x00,0x49,0x00,0x4e,0x00, 0x37,0x00,0x5c,0x00,0x53,0x00,0x51,0x00,
//           --------------------------------------------------------------------------------
             0x4c,0x00,0x45,0x00,0x58,0x00,0x50,0x00, 0x52,0x00,0x45,0x00,0x53,0x00,0x53,0x00,
//           Proc LineNumber--------- ERR- Length---  Error-Number------- Stat Clas MsgSize--
             0x00,0x01,0x00,0x00,0x00,0xaa,0x78,0x00, 0xf4,0x1f,0x00,0x00,0x01,0x10,0x23,0x00,
//           MsgContent----------------------------------------------------------------------
             0x53,0x00,0x74,0x00,0x61,0x00,0x74,0x00, 0x65,0x00,0x6d,0x00,0x65,0x00,0x6e,0x00,
//           --------------------------------------------------------------------------------
             0x74,0x00,0x28,0x00,0x73,0x00,0x29,0x00, 0x20,0x00,0x63,0x00,0x6f,0x00,0x75,0x00,
//           --------------------------------------------------------------------------------
             0x6c,0x00,0x64,0x00,0x20,0x00,0x6e,0x00, 0x6f,0x00,0x74,0x00,0x20,0x00,0x62,0x00,
//           --------------------------------------------------------------------------------
             0x65,0x00,0x20,0x00,0x70,0x00,0x72,0x00, 0x65,0x00,0x70,0x00,0x61,0x00,0x72,0x00,
//           ----------------------------- Size-ServerName-----------------------------------
             0x65,0x00,0x64,0x00,0x2e,0x00,0x12,0x49, 0x00,0x45,0x00,0x39,0x00,0x57,0x00,0x49,
//           --------------------------------------------------------------------------------
             0x00,0x4e,0x00,0x37,0x00,0x5c,0x00,0x53, 0x00,0x51,0x00,0x4c,0x00,0x45,0x00,0x58,
//           ------------------------------------------------------- Proc LineNumbe----------
             0x00,0x50,0x00,0x52,0x00,0x45,0x00,0x53, 0x00,0x53,0x00,0x00,0x01,0x00,0x00,0x00,
//           RSTA Status------------- RVAL ordinal--  varc Stat UserType----------- Flags----
             0x79,0xf4,0x1f,0x00,0x00,0xac,0x00,0x00, 0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
//           TypeInfo- Size DONP Stat----- CurCmd---  DoneRowCount---------------------------
             0x26,0x04,0x00,0xfe,0x02,0x00,0xe0,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
         },
         .size = 0x110,
         .cap_len = 0x110,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x110 - 8, .payload = 0},
             .request_status = SQL_REQUEST_ERROR,
             .set_values = SQL_REQUEST_STATUS | SQL_ERROR_MESSAGE | SQL_ERROR_CODE,
             .error_code = "208",
             .error_message = "Invalid object name 'Toto2'.",
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // Another error pdu
     {
         .packet = (uint8_t const []) {
             0x04,0x01,0x01,0x10,0x00,0x33,0x01,0x00, 0xaa,0x6a,0x00,0x66,0x00,0x00,0x00,0x01,
             0x0f,0x1c,0x00,0x49,0x00,0x6e,0x00,0x63, 0x00,0x6f,0x00,0x72,0x00,0x72,0x00,0x65,
             0x00,0x63,0x00,0x74,0x00,0x20,0x00,0x73, 0x00,0x79,0x00,0x6e,0x00,0x74,0x00,0x61,
             0x00,0x78,0x00,0x20,0x00,0x6e,0x00,0x65, 0x00,0x61,0x00,0x72,0x00,0x20,0x00,0x27,
             0x00,0x46,0x00,0x4f,0x00,0x4d,0x00,0x27, 0x00,0x2e,0x00,0x12,0x49,0x00,0x45,0x00,
             0x39,0x00,0x57,0x00,0x49,0x00,0x4e,0x00, 0x37,0x00,0x5c,0x00,0x53,0x00,0x51,0x00,
             0x4c,0x00,0x45,0x00,0x58,0x00,0x50,0x00, 0x52,0x00,0x45,0x00,0x53,0x00,0x53,0x00,
             0x00,0x01,0x00,0x00,0x00,0xaa,0x78,0x00, 0xf4,0x1f,0x00,0x00,0x01,0x10,0x23,0x00,
             0x53,0x00,0x74,0x00,0x61,0x00,0x74,0x00, 0x65,0x00,0x6d,0x00,0x65,0x00,0x6e,0x00,
             0x74,0x00,0x28,0x00,0x73,0x00,0x29,0x00, 0x20,0x00,0x63,0x00,0x6f,0x00,0x75,0x00,
             0x6c,0x00,0x64,0x00,0x20,0x00,0x6e,0x00, 0x6f,0x00,0x74,0x00,0x20,0x00,0x62,0x00,
             0x65,0x00,0x20,0x00,0x70,0x00,0x72,0x00, 0x65,0x00,0x70,0x00,0x61,0x00,0x72,0x00,
             0x65,0x00,0x64,0x00,0x2e,0x00,0x12,0x49, 0x00,0x45,0x00,0x39,0x00,0x57,0x00,0x49,
             0x00,0x4e,0x00,0x37,0x00,0x5c,0x00,0x53, 0x00,0x51,0x00,0x4c,0x00,0x45,0x00,0x58,
             0x00,0x50,0x00,0x52,0x00,0x45,0x00,0x53, 0x00,0x53,0x00,0x00,0x01,0x00,0x00,0x00,
             0x79,0xf4,0x1f,0x00,0x00,0xac,0x00,0x00, 0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
             0x26,0x04,0x00,0xfe,0x02,0x00,0xe0,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
         },
         .size = 0x110,
         .cap_len = 0x110,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x110 - 8, .payload = 0},
             .request_status = SQL_REQUEST_ERROR,
             .set_values = SQL_REQUEST_STATUS | SQL_ERROR_MESSAGE | SQL_ERROR_CODE,
             .error_code = "102",
             .error_message = "Incorrect syntax near 'FOM'.",
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // Yet another response
     {
         .packet = (uint8_t const []) {
//           Resp Stat Length--- osef---------------  ColM Count---- UserType----------- Flag
             0x04,0x01,0x01,0x66,0x00,0x35,0x01,0x00, 0x81,0x04,0x00,0x00,0x00,0x00,0x00,0x09,
//           ---- TOK1 VarL----- Collation---------------- VarChar-(name)--------------------
             0x00,0xef,0x3c,0x00,0x09,0x04,0xd0,0x00, 0x34,0x04,0x6e,0x00,0x61,0x00,0x6d,0x00,
//           --------- UserType----------- Flag-----  Toke VarL----- VarChar-(4surname)------
             0x65,0x00,0x00,0x00,0x00,0x00,0x09,0x00, 0xef,0x3c,0x00,0x09,0x04,0xd0,0x00,0x34,
//           --------------------------------------------------------------------------- User
             0x07,0x73,0x00,0x75,0x00,0x72,0x00,0x6e, 0x00,0x61,0x00,0x6d,0x00,0x65,0x00,0x00,
//           Type---------- Flag----- Toke VarL-----  Collation--------------- VarChar-(city)
             0x00,0x00,0x00,0x09,0x00,0xef,0x50,0x00, 0x09,0x04,0xd0,0x00,0x34,0x04,0x63,0x00,
//           ----------------------------- UserType------------ Flag----- Toke VarChar-(id)--
             0x69,0x00,0x74,0x00,0x79,0x00,0x00,0x00, 0x00,0x00,0x08,0x00,0x38,0x02,0x69,0x00,
//           --------- ROW1 Size----- NCharType--(zzz   )------------------------------------
             0x64,0x00,0xd1,0x3c,0x00,0x7a,0x00,0x7a, 0x00,0x7a,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           ---- Size----- NCharType2--(xxx   )---------------------------------------------
             0x00,0x3c,0x00,0x62,0x00,0x62,0x00,0x62, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------- Size
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x50,
//           ---- NCharType3-----------------------------------------------------------------
             0x00,0x63,0x00,0x78,0x00,0x78,0x00,0x78, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           --------------------------------------------------------------------------------
             0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20, 0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,
//           ---- IntVal------------- DONE Status---  CurCmd--- DoneRowCount-----------------
             0x00,0x02,0x00,0x00,0x00,0xff,0x11,0x00, 0xc1,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
//           --------- RSTA Status------------- RVAL  ordinal-- varc Stat UserType-----------
             0x00,0x00,0x79,0x00,0x00,0x00,0x00,0xac, 0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,
//           Flags---- Type VarL Size Value--------------- DONP Stat----- CurCmd--- DoneRow--
             0x00,0x00,0x26,0x04,0x04,0x01,0x00,0x00, 0x00,0xfe,0x00,0x00,0xe0,0x00,0x00,0x00,
//           -----------------------------
             0x00,0x00,0x00,0x00,0x00,0x00
         },
         .size = 0x166,
         .cap_len = 0x166,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x166 - 8, .payload = 0},
             .request_status = SQL_REQUEST_COMPLETE,
             .set_values = SQL_REQUEST_STATUS | SQL_NB_ROWS | SQL_NB_FIELDS,
             .u = { .query = { .nb_rows = 1, .nb_fields = 4 } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // Yet another another response
     {
         .packet = (uint8_t const []) {
//           Resp Stat Length--- osef---------------  DONE Status--- CurCmd--- DoneRowCount--
             0x04,0x01,0x00,0x11,0x01,0x3a,0x01,0x00, 0xfd,0x00,0x00,0xd5,0x00,0x00,0x00,0x00,
//           ----
             0x00
         },
         .size = 0x11,
         .cap_len = 0x11,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x11 - 8, .payload = 0},
             .request_status = SQL_REQUEST_COMPLETE,
             .set_values = SQL_REQUEST_STATUS,
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // An rpc
     {
         .packet = (uint8_t const []) {
             0x03,0x09,0x00,0xb9,0x00,0x00,0x01,0x00, 0x16,0x00,0x00,0x00,0x12,0x00,0x00,0x00,
             0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x01,0x00,0x00,0x00,0x0e,0x00,
             0x70,0x00,0x5f,0x00,0x47,0x00,0x65,0x00, 0x74,0x00,0x42,0x00,0x6f,0x00,0x67,0x00,
//                                                                                       @---
             0x75,0x00,0x73,0x00,0x44,0x00,0x61,0x00, 0x74,0x00,0x61,0x00,0x00,0x00,0x0b,0x40,
//           -----S---------e---------a---------r----------c---------h---------T---------y---
             0x00,0x53,0x00,0x65,0x00,0x61,0x00,0x72, 0x00,0x63,0x00,0x68,0x00,0x54,0x00,0x79,
//           -----p---------e--------
             0x00,0x70,0x00,0x65,0x00,0x00,0x26,0x01, 0x01,0x01,0x15,0x40,0x00,0x4d,0x00,0x61,
             0x00,0x78,0x00,0x57,0x00,0x61,0x00,0x69, 0x00,0x74,0x00,0x54,0x00,0x69,0x00,0x6d,
             0x00,0x65,0x00,0x49,0x00,0x6e,0x00,0x53, 0x00,0x65,0x00,0x63,0x00,0x6f,0x00,0x6e,
             0x00,0x64,0x00,0x73,0x00,0x00,0x26,0x04, 0x04,0x00,0x00,0x00,0x00,0x13,0x40,0x00,
             0x50,0x00,0x72,0x00,0x6f,0x00,0x63,0x00, 0x65,0x00,0x73,0x00,0x73,0x00,0x4e,0x00,
             0x65,0x00,0x67,0x00,0x61,0x00,0x74,0x00, 0x69,0x00,0x76,0x00,0x65,0x00,0x41,0x00,
             0x63,0x00,0x6b,0x00,0x00,0x26,0x01,0x01, 0x00
         },
         .size = 0xb9,
         .cap_len = 0xb9,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0xb9 - 8, .payload = 0},
             .request_status = SQL_REQUEST_COMPLETE,
             .set_values = SQL_SQL,
             .u = { .query = { .sql = "p_GetBogusData(@SearchType=1,@MaxWaitTimeInSeconds=0,@ProcessNegativeAck=0)" } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // An rpc
     {
         .packet = (uint8_t const []) {
//           Resp Stat Length--- osef---------------  ColM Count---- UserType----------- Flag
             0x04,0x01,0x00,0x35,0x00,0xe5,0x01,0x00, 0x81,0x01,0x00,0x00,0x00,0x00,0x00,0x21,
//           ---- Toke Variable- VarL RowT Size-----  ---------------------------------------
             0x00,0xa5,0x80,0x00,0x00,0xd1,0x10,0x00, 0x32,0x11,0xd9,0x31,0x3e,0xb3,0x91,0x3e,
//           ---------------------------------------  Done MsgStatus Cmd------ RowCount-------
             0x38,0x45,0x22,0x95,0x16,0x9a,0x34,0x9e, 0xfd,0x10,0x00,0xc1,0x00,0x01,0x00,0x00,
//           ------------------------
             0x00,0x00,0x00,0x00,0x00
         },
         .size = 0x35,
         .cap_len = 0x35,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x35 - 8, .payload = 0},
             .request_status = SQL_REQUEST_COMPLETE,
             .set_values = SQL_REQUEST_STATUS | SQL_NB_ROWS | SQL_NB_FIELDS,
             .msg_type = SQL_QUERY,
             .u = { .query = { .nb_fields = 1, .nb_rows = 1 } },
         },
         .called = true,
     },

     // A simple select version
     {
         .packet = (uint8_t const []) {
//           Type Stat Length--- osef---------------
             0x01,0x01,0x00,0x1a,0x00,0x00,0x00,0x00, 0x20,0x53,0x45,0x4c,0x45,0x43,0x54,0x20,
             0x40,0x40,0x56,0x45,0x52,0x53,0x49,0x4f, 0x4e,0x20
         },
         .size = 0x1a,
         .cap_len = 0x1a,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x1a - 8, .payload = 0},
             .set_values = SQL_SQL,
             .u = { .query = { .sql = " SELECT @@VERSION ", .truncated=false } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // Another simple select version
     {
         .packet = (uint8_t const []) {
             0x01,0x01,0x00,0x18,0x00,0x00,0x00,0x00,0x73,0x65,0x6c,0x65,0x63,0x74,0x20,0x40,
             0x40,0x76,0x65,0x72,0x73,0x69,0x6f,0x6e
         },
         .size = 0x18,
         .cap_len = 0x18,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x18 - 8, .payload = 0},
             .set_values = SQL_SQL,
             .u = { .query = { .sql = "select @@version", .truncated=false } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // An sql batch
     {
         .packet = (uint8_t const []) {
             0x01,0x01,0x00,0x90,0x00,0x00,0x01,0x00,0x16,0x00,0x00,0x00,0x12,0x00,0x00,0x00,
             0x02,0x00,0x50,0x00,0x00,0x00,0x3b,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x53,0x00,
             0x45,0x00,0x4c,0x00,0x45,0x00,0x43,0x00,0x54,0x00,0x20,0x00,0x50,0x00,0x72,0x00,
             0x69,0x00,0x76,0x00,0x69,0x00,0x6c,0x00,0x65,0x00,0x67,0x00,0x65,0x00,0x20,0x00,
             0x46,0x00,0x52,0x00,0x4f,0x00,0x4d,0x00,0x20,0x00,0x4f,0x00,0x52,0x00,0x5f,0x00,
             0x50,0x00,0x72,0x00,0x69,0x00,0x76,0x00,0x69,0x00,0x6c,0x00,0x65,0x00,0x67,0x00,
             0x65,0x00,0x73,0x00,0x20,0x00,0x57,0x00,0x49,0x00,0x54,0x00,0x48,0x00,0x20,0x00,
             0x28,0x00,0x58,0x00,0x4c,0x00,0x4f,0x00,0x43,0x00,0x4b,0x00,0x2c,0x00,0x20,0x00,
             0x52,0x00,0x4f,0x00,0x57,0x00,0x4c,0x00,0x4f,0x00,0x43,0x00,0x4b,0x00,0x29,0x00
         },
         .size = 0x90,
         .cap_len = 0x90,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x90 - 8, .payload = 0},
             .set_values = SQL_SQL,
             .u = { .query = { .sql = "SELECT Privilege FROM OR_Privileges WITH (XLOCK, ROWLOCK)", .truncated=false } },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

     // A partial query
     {
         .packet = (uint8_t const []) {
//           Quer  Stat  Length----  Chan------  PktN  Wind  Pack
             0x03, 0x0c, 0x1f, 0x40, 0x00, 0x00, 0x01, 0x00, 0x16, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00,
             0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff,
             0x0a, 0x00, 0x02, 0x00, 0x00, 0x00, 0x63, 0x6a, 0x89, 0x00, 0x00, 0x09, 0x04, 0xf0, 0x00, 0x36,
             0x6a, 0x89, 0x00, 0x00, 0x53, 0x00, 0x45, 0x00, 0x4c, 0x00, 0x45, 0x00, 0x43, 0x00, 0x54, 0x00,
             0x20, 0x00, 0x5b, 0x00, 0x61, 0x00, 0x30, 0x00, 0x31, 0x00, 0x5d, 0x00, 0x2e, 0x00, 0x5b, 0x00,
             0x54, 0x00, 0x6f, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x6c, 0x00, 0x49, 0x00,
             0x44, 0x00, 0x5d, 0x00, 0x2c, 0x00, 0x20, 0x00, 0x5b, 0x00, 0x61, 0x00, 0x30, 0x00, 0x31, 0x00,
             0x5d, 0x00, 0x2e, 0x00, 0x5b, 0x00, 0x4f, 0x00, 0x63, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x49, 0x00,
             0x44, 0x00, 0x5d, 0x00, 0x2c, 0x00, 0x20, 0x00, 0x5b, 0x00, 0x61, 0x00, 0x30, 0x00, 0x31, 0x00,
             0x5d, 0x00, 0x2e, 0x00, 0x5b, 0x00, 0x4e, 0x00, 0x75, 0x00, 0x6d, 0x00, 0x65, 0x00, 0x72, 0x00,
             0x6f, 0x00, 0x4f, 0x00, 0x63, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x6e, 0x00, 0x69, 0x00, 0x6f, 0x00,
             0x5d, 0x00, 0x2c, 0x00, 0x20, 0x00, 0x5b, 0x00, 0x61, 0x00, 0x30, 0x00, 0x31, 0x00, 0x5d, 0x00,
             0x2e, 0x00, 0x5b, 0x00, 0x76, 0x00, 0x61, 0x00, 0x6c, 0x00, 0x75, 0x00, 0x65, 0x00, 0x5d, 0x00,
             0x20, 0x00, 0x41, 0x00, 0x53, 0x00, 0x20, 0x00, 0x5b, 0x00, 0x4f, 0x00, 0x63, 0x00, 0x74, 0x00,
         },
         .size = 0x1f40,
         .cap_len = 0xe0,
         .ret = PROTO_OK,
         .way = FROM_SERVER,
         .expected = {
             .info = { .head_len = 0x1f40 - 8, .payload = 0},
             .set_values = SQL_SQL,
             .u = { .query = { .sql = "ExecuteSql(SELECT [a01].[TotololID], [a01].[OctoID], [a01].[NumeroOctonio], [a01].[value] AS [Oct" , .truncated = true} },
             .msg_type = SQL_QUERY,
         },
         .called = true,
     },

};

static unsigned cur_test;
static unsigned check_called = 0;

static void tds_info_check(struct proto_subscriber unused_ *s, struct proto_info const *info_, size_t unused_ cap_len, uint8_t const unused_ *packet, struct timeval const unused_ *now)
{
    check_called++;
    // Ignore non sql message
    if (info_->parser->proto != proto_tds_msg) {
        return;
    }
    // Check info against parse_tests[cur_test].expected
    struct sql_proto_info const *const info = DOWNCAST(info_, info, sql_proto_info);
    struct sql_proto_info const *const expected = &parse_tests[cur_test].expected;
    assert(!compare_expected_sql(info, expected));
}

static void parse_check(void)
{
    struct timeval now;
    timeval_set_now(&now);
    struct parser *parser = proto_tds->ops->parser_new(proto_tds);
    struct tds_parser *tds_parser = DOWNCAST(parser, parser, tds_parser);
    struct tds_msg_parser **tds_msg_parser = (struct tds_msg_parser **)&tds_parser->msg_parser;
    assert(tds_parser);
    struct proto_subscriber sub;
    hook_subscriber_ctor(&pkt_hook, &sub, tds_info_check);
    for (cur_test = 0; cur_test < NB_ELEMS(parse_tests); cur_test++) {
        struct parse_test const *test = parse_tests + cur_test;
        printf("Check packet %d of size 0x%x (%d)\n", cur_test, test->size, test->size);
        unsigned old_check = check_called;
        tds_parser->channels[0] = 0;
        tds_parser->channels[1] = 0;
        if (*tds_msg_parser) (*tds_msg_parser)->pre_7_2 = false;
        enum proto_parse_status ret = tds_parse(parser, NULL, test->way, test->packet, test->cap_len,
                test->size, &now, test->cap_len, test->packet);
        if (test->called && (old_check + 1 != check_called)) {
            printf("Expected callback to be called\n");
            assert(old_check + 1 == check_called);
        } else if (!test->called && (old_check != check_called)){
            printf("Expected callback to not be called\n");
            assert(old_check == check_called);
        }
        assert(ret == test->ret);
    }
    hook_subscriber_dtor(&pkt_hook, &sub);
}

static void check_string_buffer(struct string_buffer *buffer, char *expected, bool truncated)
{
    buffer_get_string(buffer);
    if (truncated != buffer->truncated) {
        printf("Buffer %s should %s be truncated\n", string_buffer_2_str(buffer), truncated ? "" : "not");
        assert(truncated == buffer->truncated);
    }
    if (0 != strcmp(buffer->head, expected)) {
        printf("Buffer %s string should be %s\n", string_buffer_2_str(buffer), expected);
        assert(0 == strcmp(buffer->head, expected));
    }
}

static void append_us_varchar_check()
{
    static uint8_t unicode_strings[] = {
        0x1c,0x00,0x49,0x00,0x6e,0x00,0x76,0x00,0x61,0x00,0x6c,0x00,0x69,0x00,0x64,0x00,
        0x20,0x00,0x6f,0x00,0x62,0x00,0x6a,0x00,0x65,0x00,0x63,0x00,0x74,0x00,0x20,0x00,
        0x6e,0x00,0x61,0x00,0x6d,0x00,0x65,0x00,0x20,0x00,0x27,0x00,0x54,0x00,0x6f,0x00,
        0x74,0x00,0x6f,0x00,0x32,0x00,0x27,0x00,0x2e,0x00};
    char dst[256];
    struct string_buffer buffer;
    string_buffer_ctor(&buffer, dst, sizeof(dst));
    struct cursor cursor;
    cursor_ctor(&cursor, unicode_strings, sizeof(unicode_strings));

    append_us_varchar(&buffer, &cursor);
    check_string_buffer(&buffer, "Invalid object name 'Toto2'.", false);
}

int main(void)
{
    log_init();
    ext_init();
    objalloc_init();
    ref_init();
    proto_init();
    port_muxer_init();
    pkt_wait_list_init();
    streambuf_init();
    eth_init();
    ip_init();
    ip6_init();
    tcp_init();
    tds_init();
    tds_msg_init();
    log_set_level(LOG_DEBUG, NULL);
    log_set_file("tds_check.log");

    append_us_varchar_check();

    parse_check();

    stress_check(proto_tds);
    stress_check(proto_tds_msg);

    doomer_stop();
    tds_msg_fini();
    tds_fini();
    tcp_fini();
    ip6_fini();
    ip_fini();
    eth_fini();
    streambuf_fini();
    pkt_wait_list_fini();
    port_muxer_fini();
    proto_fini();
    ref_fini();
    objalloc_fini();
    ext_fini();
    log_fini();
    return EXIT_SUCCESS;
}

