// -*- c-basic-offset: 4; c-backslash-column: 79; indent-tabs-mode: nil -*-
// vim:sw=4 ts=4 sts=4 expandtab
#include <stdlib.h>
#undef NDEBUG
#include <assert.h>
#include <time.h>
#include <junkie/cpp.h>
#include <junkie/tools/miscmacs.h>
#include <junkie/tools/ext.h>
#include <junkie/tools/objalloc.h>
#include <junkie/proto/pkt_wait_list.h>
#include <junkie/proto/udp.h>
#include <junkie/proto/tcp.h>
#include <junkie/proto/ip.h>
#include <junkie/proto/eth.h>
#include <junkie/proto/cap.h>
#include <junkie/proto/dns.h>
#include "lib.h"

/*
 * Parse Check
 */

static struct parse_test {
    uint8_t const *packet;
    size_t size;
    struct dns_proto_info expected;
    int expected_return;
} parse_tests[] = {
    {
        .packet = (uint8_t const []) {
            0x8c, 0xcf, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x6c, 0x65, 0x6d,
            0x6f, 0x6e, 0x64, 0x65, 0x02, 0x66, 0x72, 0x00, 0x00, 0x1c, 0x00, 0x01,
        },
        .size = 16+12,
        .expected_return = PROTO_OK,
        .expected = {
            .info = { .head_len = 16+12, .payload = 0 },
            .query = true, .transaction_id = 0x8ccf, .error_code = 0,
            .request_type = DNS_TYPE_AAAA, .dns_class = DNS_CLASS_IN,
            .name = "lemonde.fr"
        },
    }, {
        .packet = (uint8_t const []) {
            0x8c, 0xcf, 0x81, 0x80, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x07, 0x6c, 0x65, 0x6d,
            0x6f, 0x6e, 0x64, 0x65, 0x02, 0x66, 0x72, 0x00, 0x00, 0x1c, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x06,
            0x00, 0x01, 0x00, 0x00, 0x02, 0x58, 0x00, 0x30, 0x03, 0x6e, 0x73, 0x31, 0x06, 0x74, 0x65, 0x2d,
            0x64, 0x6e, 0x73, 0x03, 0x6e, 0x65, 0x74, 0x00, 0x09, 0x64, 0x6e, 0x73, 0x6d, 0x61, 0x73, 0x74,
            0x65, 0x72, 0xc0, 0x2c, 0x77, 0xbf, 0x85, 0x49, 0x00, 0x00, 0x38, 0x40, 0x00, 0x00, 0x0e, 0x10,
            0x00, 0x09, 0x3a, 0x80, 0x00, 0x00, 0x38, 0x40,
        },
        .size = 16*5+8,
        .expected_return = PROTO_OK,
        .expected = {
            .info = { .head_len = 16*5+8, .payload = 0 },
            .query = false, .transaction_id = 0x8ccf, .error_code = 0,
            .request_type = DNS_TYPE_AAAA, .dns_class = DNS_CLASS_IN,
            .name = "lemonde.fr"
        },
    }, {
        .packet = (uint8_t const []) {
            0x12, 0x78, 0x85, 0x83, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x23, 0x63, 0x65, 0x64,
            0x6f, 0x6d, 0x61, 0x69, 0x6e, 0x65, 0x6e, 0x65, 0x72, 0x69, 0x73, 0x71, 0x75, 0x65, 0x70, 0x61,
            0x73, 0x64, 0x65, 0x78, 0x69, 0x73, 0x74, 0x65, 0x72, 0x2d, 0x68, 0x61, 0x68, 0x61, 0x68, 0x61,
            0x03, 0x6f, 0x72, 0x67, 0x04, 0x6c, 0x61, 0x62, 0x6f, 0x0b, 0x73, 0x65, 0x63, 0x75, 0x72, 0x61,
            0x63, 0x74, 0x69, 0x76, 0x65, 0x03, 0x6c, 0x61, 0x6e, 0x00, 0x00, 0x01, 0x00, 0x01, 0xc0, 0x34,
            0x00, 0x06, 0x00, 0x01, 0x00, 0x01, 0x51, 0x80, 0x00, 0x30, 0x09, 0x6c, 0x6f, 0x63, 0x61, 0x6c,
            0x68, 0x6f, 0x73, 0x74, 0x00, 0x04, 0x72, 0x6f, 0x6f, 0x74, 0x09, 0x6c, 0x6f, 0x63, 0x61, 0x6c,
            0x68, 0x6f, 0x73, 0x74, 0xc0, 0x34, 0x30, 0x29, 0x45, 0xc1, 0x00, 0x00, 0x70, 0x80, 0x00, 0x00,
            0x03, 0x0c, 0x00, 0x09, 0x3a, 0x80, 0x00, 0x01, 0x51, 0x80,
        },
        .size = 16*8+10,
        .expected_return = PROTO_OK,
        .expected = {
            .info = { .head_len = 16*8+10, .payload = 0 },
            .query = false, .transaction_id = 0x1278, .error_code = 3,
            .request_type = DNS_TYPE_A, .dns_class = DNS_CLASS_IN,
            .name = "cedomainenerisquepasdexister-hahaha.org.labo.securactive.lan"
        },
    }, {    // A NetBios type DNS query (NBNS)
        .packet = (uint8_t const []) {
            0xa3, 0x7a, 0x01, 0x10, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x46, 0x41, 0x45,
            0x44, 0x43, 0x4e, 0x45, 0x45, 0x45, 0x46, 0x43, 0x4e, 0x45, 0x45, 0x45, 0x46, 0x45, 0x4d, 0x46,
            0x41, 0x45, 0x49, 0x45, 0x4a, 0x45, 0x4f, 0x45, 0x46, 0x43, 0x41, 0x42, 0x4d, 0x00, 0x00, 0x20,
            0x00, 0x01,
        },
        .size = 16*3+2,
        .expected_return = PROTO_OK,
        .expected = {
            .info = { .head_len = 16*3+2, .payload = 0 },
            .query = true, .transaction_id = 0xa37a, .error_code = 0,
            .request_type = DNS_TYPE_NBNS, .dns_class = DNS_CLASS_IN,
            .name = "PC-DE-DELPHINE \x1c"
        },
    }, {
        .packet = (uint8_t const []) {
            0xf9, 0x39, 0x01, 0x10, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x45, 0x42, 0x46,
            0x45, 0x45, 0x49, 0x45, 0x46, 0x45, 0x4f, 0x45, 0x46, 0x43, 0x4e, 0x45, 0x47, 0x45, 0x4a, 0x45,
            0x4d, 0x45, 0x46, 0x46, 0x44, 0x45, 0x46, 0x46, 0x43, 0x46, 0x47, 0x41, 0x41, 0x00, 0x00, 0x20,
            0x00, 0x01,
        },
        .size = 16*3+2,
        .expected_return = PROTO_OK,
        .expected = {
            .info = { .head_len = 16*3+2, .payload = 0 },
            .query = true, .transaction_id = 0xf939, .error_code = 0,
            .request_type = DNS_TYPE_NBNS, .dns_class = DNS_CLASS_IN,
            .name = "ATHENE-FILESERV"
        },
    }, {
        .packet = (uint8_t const []) {
            0xae, 0x1a, 0x5a, 0x5a, 0x00, 0x00, 0xb9, 0x98, 0x20, 0x5e, 0x58, 0xa0, 0x2b, 0x5c, 0xf7, 0x26,
            0x6f, 0xaf, 0xf3, 0x4e
        },
        .size = 20,
        .expected_return = PROTO_PARSE_ERR,
    }, {
        .packet = (uint8_t const []) {
            0x37, 0x08, 0xf2, 0xe4, 0x00, 0x01, 0x31, 0x0a, 0xd1, 0x2f, 0xde, 0xf9, 0x28, 0xb2, 0xa4, 0x5e,
            0x01, 0xe8, 0xf4, 0x49
        },
        .size = 20,
        .expected_return = PROTO_PARSE_ERR,
    }, {
        .packet = (uint8_t const []) {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x53, 0x46, 0x54,
            0x50, 0x20, 0x46, 0x69, 0x6c, 0x65, 0x20, 0x54, 0x72, 0x61, 0x6e, 0x73, 0x66, 0x65, 0x72, 0x20,
            0x6f, 0x6e, 0x20, 0x6f, 0x70, 0x74, 0x69, 0x70, 0x6c, 0x65, 0x78, 0x71, 0x75, 0x61, 0x64, 0x09,
            0x5f, 0x73, 0x66, 0x74, 0x70, 0x2d, 0x73, 0x73, 0x68, 0x04, 0x5f, 0x74, 0x63, 0x70, 0x05, 0x6c,
            0x6f, 0x63, 0x61, 0x6c, 0x00, 0x00, 0x21, 0x00, 0x01, 0x0c, 0x6f, 0x70, 0x74, 0x69, 0x70, 0x6c,
            0x65, 0x78, 0x71, 0x75, 0x61, 0x64, 0xc0, 0x3e, 0x00, 0x01, 0x00, 0x01, 0x9a, 0x8b, 0x1c, 0x49,
            0x9d, 0x76, 0x00, 0x00, 0x9e, 0x00, 0x00, 0x00, 0x9e, 0x00, 0x00, 0x00, 0x01, 0x00, 0x5e, 0x00,
            0x00, 0xfb, 0x00, 0x1e, 0xc9, 0x1b, 0x5a, 0x33, 0x08, 0x00, 0x45, 0x00, 0x00, 0x90, 0x00, 0x00,
            0x40, 0x00, 0xff, 0x11, 0xef, 0xf3, 0x0a, 0x00, 0xa0, 0x6d, 0xe0, 0x00, 0x00, 0xfb, 0x14, 0xe9,
            0x14, 0xe9, 0x00, 0x7c, 0x77, 0xcf, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00,
            0x00, 0x00, 0x0c, 0x6f, 0x70, 0x74, 0x69, 0x70, 0x6c, 0x65, 0x78, 0x71, 0x75, 0x61, 0x64, 0x05,
            0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x00, 0x00, 0x01, 0x80, 0x01, 0x00, 0x00, 0x00, 0x78, 0x00, 0x04,
            0x0a, 0x00, 0xa0, 0x6d, 0x22, 0x53, 0x46, 0x54, 0x50, 0x20, 0x46, 0x69, 0x6c, 0x65, 0x20, 0x54,
            0x72, 0x61, 0x6e, 0x73, 0x66, 0x65, 0x72, 0x20, 0x6f, 0x6e, 0x20, 0x6f, 0x70, 0x74, 0x69, 0x70,
            0x6c, 0x65, 0x78, 0x71, 0x75, 0x61, 0x64, 0x09, 0x5f, 0x73, 0x66, 0x74, 0x70, 0x2d, 0x73, 0x73,
            0x68, 0x04, 0x5f, 0x74, 0x63, 0x70, 0xc0, 0x19, 0x00, 0x21, 0x80, 0x01, 0x00, 0x00, 0x00, 0x78,
            0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0xc0, 0x0c
        },
        .size = 92,
        .expected_return = PROTO_OK,
        .expected = {
            .info = { .head_len = 92, .payload = 0 },
            .query = true, .transaction_id = 0x0000, .error_code = 0,
            .request_type = DNS_TYPE_SRV, .dns_class = DNS_CLASS_IN,
            .name = "SFTP File Transfer on optiplexquad._sftp-ssh._tcp.local"
        },
    },
};

static unsigned current_test;

static void dns_info_check(struct proto_subscriber unused_ *s, struct proto_info const *info_, size_t unused_ cap_len, uint8_t const unused_ *packet, struct timeval const unused_ *now)
{
    struct dns_proto_info const *const info = DOWNCAST(info_, info, dns_proto_info);
    struct dns_proto_info const *const expected = &parse_tests[current_test].expected;

#   define CHECK(field) assert(info->field == expected->field);
    CHECK(info.head_len);
    CHECK(info.payload);
    CHECK(query);
    CHECK(transaction_id);
    CHECK(error_code);
    CHECK(request_type);
    CHECK(dns_class);
    assert(0 == strcmp(info->name, expected->name));
}

static void parse_check(void)
{
    struct timeval now;
    timeval_set_now(&now);
    struct parser *dns_parser = proto_dns->ops->parser_new(proto_dns);
    assert(dns_parser);
    struct proto_subscriber sub;
    hook_subscriber_ctor(&pkt_hook, &sub, dns_info_check);

    for (current_test = 0; current_test < NB_ELEMS(parse_tests); current_test++) {
        struct parse_test const *test = parse_tests + current_test;
        printf("Testing packet %u...", current_test);
        int ret = dns_parse(dns_parser, NULL, 0, test->packet, test->size, test->size, &now, test->size, test->packet);
        assert(test->expected_return == ret);
        printf("Ok\n");
    }

    hook_subscriber_dtor(&pkt_hook, &sub);
    parser_unref(&dns_parser);
}

/*
 * QNAME Extraction
 */

static void qname_check(void)
{
    static struct qname_test {
        uint8_t const payload[256];
        size_t len;
        char const *expected;
    } tests[] = {
        {
            .payload = {
                2, 'h', 'g', 2, 'r', 'd',
                11, 's', 'e', 'c', 'u', 'r', 'a', 'c', 't', 'i', 'v', 'e',
                3, 'n', 'e', 't', '\0'
            },
            .len = 23,
            .expected = "hg.rd.securactive.net",
        }, {
            .payload = {
                3 /*here is the error */ , 'h', 'g', 2, 'r', 'd',
                11, 's', 'e', 'c', 'u', 'r', 'a', 'c', 't', 'i', 'v', 'e',
                3, 'n', 'e', 't', '\0'
            },
            .len = 23,
            .expected = NULL,
        }, {
            .payload = { 0 },
            .len = 1,
            .expected = "",
        }, {
            .payload = { 12 },
            .len = 1,
            .expected = NULL,
        }, {
            .payload = { 2, 'a', 'a', 190, 'b', 'b', 'b', 0 },
            .len = 8,
            .expected = NULL,
        }

    };

    for (unsigned t = 0; t < NB_ELEMS(tests); t++) {
        struct qname_test *test = tests+t;
        char tmp[256];
        printf("Testing QNAME %u...", t);
        ssize_t ret = extract_qname(tmp, sizeof(tmp), test->payload, test->len, false);
        if (test->expected) {
            assert(ret >= 0);
            assert(0 == strcmp(tmp, test->expected));
        } else {
            assert(ret < 0);
        }
        printf("Ok\n");
    }
}

static void looks_like_netbios_check(void)
{
    assert(looks_like_netbios("CKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"));
    assert(looks_like_netbios("EDFEFIFDFDEFDCDDCACACACACACACAAA.."));
    assert(looks_like_netbios("EEEDDADDCOEJEOEGEPEDEMEFCOEDEPEN.."));
    assert(!looks_like_netbios("le joli petit lapin rose"));
    assert(!looks_like_netbios("CKAAA"));
}

int main(void)
{
    log_init();
    ext_init();
    objalloc_init();
    pkt_wait_list_init();
    ref_init();
    proto_init();
    cap_init();
    eth_init();
    ip_init();
    ip6_init();
    udp_init();
    tcp_init();
    dns_init();
    log_set_level(LOG_DEBUG, NULL);
    log_set_file("dns_check.log");

    parse_check();
    looks_like_netbios_check();
    qname_check();
    stress_check(proto_dns);

    doomer_stop();
    dns_fini();
    tcp_fini();
    udp_fini();
    ip6_fini();
    ip_fini();
    eth_fini();
    cap_fini();
    proto_fini();
    ref_fini();
    pkt_wait_list_fini();
    objalloc_fini();
    ext_fini();
    log_fini();
    return EXIT_SUCCESS;
}

