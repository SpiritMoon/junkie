// -*- c-basic-offset: 4; c-backslash-column: 79; indent-tabs-mode: nil -*-
// vim:sw=4 ts=4 sts=4 expandtab

#include <stdlib.h>
#include "junkie/proto/der.h"
#include "lib_test_junkie.h"

static struct parse_test {
    size_t size;
    uint8_t const packet[64];
    struct der expected;
} parse_tests [] = {
    {
        .size = 0xc,
        .packet = {
            0x06, 0x0a, 0x2b, 0x06, 0x01, 0x04, 0x01, 0x82, 0x37, 0x02, 0x02, 0x0a
        },
        .expected = {
            .class_identifier = DER_UNIVERSAL,
            .type = DER_PRIMITIVE,
            .class_tag = DER_OBJECT_IDENTIFIER,
            .length = 0x0a,
        },
    },
};

static void der_check(struct der *der, struct der *expected)
{
    CHECK_INT(der->class_identifier, expected->class_identifier);
    CHECK_INT(der->type, expected->type);
    CHECK_INT(der->class_tag, expected->class_tag);
    CHECK_INT(der->length, expected->length);
}

static void parse_check(void)
{
    for (unsigned i = 0; i < NB_ELEMS(parse_tests); i++) {
        struct cursor cursor;
        struct parse_test parse_test = parse_tests[i];
        cursor_ctor(&cursor, parse_test.packet, parse_test.size);
        struct der der;
        enum proto_parse_status ret = cursor_read_der(&cursor, &der);
        assert(PROTO_OK == ret);
        der_check(&der, &parse_test.expected);
    }
}

static void check_oid(uint8_t *source, size_t source_size, uint32_t *expected_oid, uint8_t expected_oid_length)
{
    uint32_t oid[expected_oid_length];
    struct cursor cursor = {.head = source, .cap_len = source_size};
    uint8_t oid_length;
    cursor_read_oid(&cursor, source_size, oid, &oid_length);
    if (oid_length != expected_oid_length) {
        SLOG(LOG_ERR, "Oid size incorrect (%d != %d), expected:\n%s\ngot:\n%s",
                expected_oid_length, oid_length,
                oid_2_str(expected_oid, expected_oid_length), oid_2_str(oid, oid_length));
        assert(oid_length == expected_oid_length);
    }
    for (unsigned i = 0; i < oid_length; i++) {
        if (expected_oid[i] != oid[i]) {
            SLOG(LOG_ERR, "Problem of oid at %d (expected %"PRIu16", got %"PRIu16")\n", i,
                    expected_oid[i], oid[i]);
            assert(expected_oid[i] == oid[i]);
        }
    }
}

static void read_oid_check(void)
{
    uint8_t pkt[9] = {0x2b, 0x06, 0x01, 0x04, 0x01, 0x82, 0x37, 0x15, 0x14};
    uint32_t expected_oid[9] = {1, 3, 6, 1, 4, 1 ,311, 21, 20};
    check_oid(pkt, NB_ELEMS(pkt), expected_oid, NB_ELEMS(expected_oid));

    uint8_t pkt2[9] = {0x2a, 0x86, 0x48, 0x82, 0xf7, 0x12, 0x01, 0x02, 0x02};
    uint32_t expected_oid2[7] = {1, 2, 840, 48018, 1, 2, 2};
    check_oid(pkt2, NB_ELEMS(pkt2), expected_oid2, NB_ELEMS(expected_oid2));

    uint8_t pkt3[9] = {0x2a, 0x86, 0x48, 0x86, 0xf7, 0x12, 0x01, 0x02, 0x02};
    uint32_t expected_oid3[7] = {1, 2, 840, 113554, 1, 2, 2};
    check_oid(pkt3, NB_ELEMS(pkt3), expected_oid3, NB_ELEMS(expected_oid3));
}

static void read_recursif_der(void)
{
    uint8_t pkt[292] = {
//      Type  Lenght----------  Sequ  Lenght----------  Inte  Lenght----------  Type  Lenght----------
        0xa1, 0x82, 0x01, 0x20, 0x30, 0x82, 0x01, 0x1c, 0xa2, 0x82, 0x01, 0x18, 0x04, 0x82, 0x01, 0x14,
//      NTLMSSP---------------------------------
        0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53, 0x50, 0x00, 0x03, 0x00, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00,
        0x40, 0x00, 0x00, 0x00, 0x82, 0x00, 0x82, 0x00, 0x58, 0x00, 0x00, 0x00, 0x12, 0x00, 0x12, 0x00,
        0xda, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0xec, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00,
        0xf4, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00, 0x04, 0x01, 0x00, 0x00, 0x15, 0x82, 0x08, 0x60,
        0x60, 0x62, 0xf3, 0xc1, 0x1b, 0x58, 0x2f, 0xe5, 0xaa, 0x96, 0xe3, 0x45, 0x05, 0xd1, 0xe9, 0xe4,
        0xeb, 0x95, 0x07, 0x1f, 0xe5, 0x31, 0x5f, 0x8a, 0xbb, 0x1a, 0x66, 0x90, 0x6b, 0xfd, 0x48, 0xc0,
        0x4d, 0x81, 0xa5, 0x75, 0xc9, 0xc0, 0xe8, 0x7d, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x80, 0x91, 0xde, 0x78, 0x43, 0x9b, 0xcf, 0x01, 0x53, 0x69, 0xea, 0x48, 0xc7, 0x55, 0xb6, 0x35,
        0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x16, 0x00, 0x52, 0x00, 0x41, 0x00, 0x43, 0x00, 0x4b, 0x00,
        0x53, 0x00, 0x54, 0x00, 0x41, 0x00, 0x54, 0x00, 0x49, 0x00, 0x4f, 0x00, 0x4e, 0x00, 0x01, 0x00,
        0x16, 0x00, 0x52, 0x00, 0x41, 0x00, 0x43, 0x00, 0x4b, 0x00, 0x53, 0x00, 0x54, 0x00, 0x41, 0x00,
        0x54, 0x00, 0x49, 0x00, 0x4f, 0x00, 0x4e, 0x00, 0x04, 0x00, 0x00, 0x00, 0x03, 0x00, 0x16, 0x00,
        0x52, 0x00, 0x61, 0x00, 0x63, 0x00, 0x6b, 0x00, 0x53, 0x00, 0x74, 0x00, 0x61, 0x00, 0x74, 0x00,
        0x69, 0x00, 0x6f, 0x00, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x57, 0x00, 0x4f, 0x00, 0x52, 0x00,
        0x4b, 0x00, 0x47, 0x00, 0x52, 0x00, 0x4f, 0x00, 0x55, 0x00, 0x50, 0x00, 0x74, 0x00, 0x6f, 0x00,
        0x74, 0x00, 0x6f, 0x00, 0x43, 0x00, 0x43, 0x00, 0x45, 0x00, 0x4c, 0x00, 0x4c, 0x00, 0x49, 0x00,
        0x45, 0x00, 0x52, 0x00, 0x4c, 0x94, 0x8c, 0xc4, 0x67, 0xc4, 0x11, 0x57, 0x13, 0x86, 0x64, 0x72,
        0x2c, 0x35, 0x5a, 0x00
    };

    struct der expecteds[4] = {
        {
            .class_identifier = DER_CONTEXT_SPECIFIC,
            .type = DER_CONSTRUCTED,
            .class_tag = DER_BOOLEAN,
            .length = 0x120,
        }, {
            .class_identifier = DER_UNIVERSAL,
            .type = DER_CONSTRUCTED,
            .class_tag = DER_SEQUENCE,
            .length = 0x11c,
        }, {
            .class_identifier = DER_CONTEXT_SPECIFIC,
            .type = DER_CONSTRUCTED,
            .class_tag = DER_INTEGER,
            .length = 0x118,
        }, {
            .class_identifier = DER_UNIVERSAL,
            .type = DER_PRIMITIVE,
            .class_tag = DER_OCTET_STRING,
            .length = 0x114,
        },
    };

    struct cursor cursor = {.head = pkt, .cap_len = 292};

    for (int i = 0; i < 4; ++i)
    {
        struct der der;
        cursor_read_der(&cursor, &der);
        SLOG(LOG_INFO, "Der found: %s\n", der_2_str(&der));
        der_check(&der, &expecteds[i]);
    }
}

int main(void)
{
    log_init();
    log_set_level(LOG_DEBUG, NULL);
    log_set_file("der_check.log");

    parse_check();
    read_oid_check();
    read_recursif_der();

    log_fini();
}

