// -*- c-basic-offset: 4; c-backslash-column: 79; indent-tabs-mode: nil -*-
// vim:sw=4 ts=4 sts=4 expandtab
#include <stdlib.h>
#undef NDEBUG
#include <assert.h>
#include <junkie/cpp.h>
#include <junkie/tools/ext.h>
#include <junkie/tools/objalloc.h>
#include <junkie/proto/pkt_wait_list.h>
#include <junkie/proto/cap.h>
#include <junkie/proto/ip.h>
#include <junkie/proto/eth.h>
#include <junkie/proto/tcp.h>
#include "lib_test_junkie.h"
#include "proto/cifs.c"

static struct parse_test {
    char const *name;
    uint8_t const *packet;
    int size;
    enum proto_parse_status ret;
    struct cifs_proto_info expected;
    bool way;
} parse_tests[] = {

    {
        .name = "A negociate response",
        .packet = (uint8_t const []) {
//          Header-{-               Nego
            0xff, 0x53, 0x4d, 0x42, 0x72, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
//                                                                                                      -}
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x47, 0x00, 0x00, 0x01, 0x00,
//          WC-
            0x11, 0x02, 0x00, 0x03, 0x32, 0x00, 0x01, 0x00, 0x04, 0x41, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
//                                  Capabilities----------
            0xcc, 0x77, 0x00, 0x00, 0xfd, 0xf3, 0x80, 0x00, 0x00, 0xb5, 0x65, 0x00, 0x86, 0x6f, 0xcf, 0x01,
//                      Chal  BC--------
            0x88, 0xff, 0x08, 0x1c, 0x00, 0xbc, 0x52, 0x94, 0xe1, 0x5d, 0xf2, 0x8f, 0x5f, 0x57, 0x00, 0x4f,
            0x00, 0x52, 0x00, 0x4b, 0x00, 0x47, 0x00, 0x52, 0x00, 0x4f, 0x00, 0x55, 0x00, 0x50, 0x00, 0x00,
            0x00
        },
        .size = 0x61,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x61 - SMB_HEADER_SIZE},
            .command.smb_command = SMB_COM_NEGOCIATE ,
            .domain = "WORKGROUP",
            .set_values = CIFS_DOMAIN,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Session setup andx query",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xd0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x59, 0x00, 0x00, 0x0e, 0x00,
            0x0d, 0xff, 0x00, 0x00, 0x00, 0x54, 0x40, 0x32, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18,
            0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0xd0, 0x80, 0x00, 0xa9, 0x00, 0x75, 0xd9, 0x4e,
            0xda, 0xbf, 0x5f, 0x86, 0xf1, 0xa4, 0x52, 0x97, 0x2d, 0x45, 0x05, 0xe4, 0x69, 0x06, 0xcd, 0xdb,
            0xaa, 0xe9, 0x89, 0x16, 0x6e, 0x75, 0xd9, 0x4e, 0xda, 0xbf, 0x5f, 0x86, 0xf1, 0xa4, 0x52, 0x97,
            0x2d, 0x45, 0x05, 0xe4, 0x69, 0x06, 0xcd, 0xdb, 0xaa, 0xe9, 0x89, 0x16, 0x6e, 0x00, 0x72, 0x00,
            0x6f, 0x00, 0x6f, 0x00, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x69, 0x00, 0x6e, 0x00,
            0x75, 0x00, 0x78, 0x00, 0x20, 0x00, 0x76, 0x00, 0x65, 0x00, 0x72, 0x00, 0x73, 0x00, 0x69, 0x00,
            0x6f, 0x00, 0x6e, 0x00, 0x20, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x32, 0x00, 0x2e, 0x00, 0x30, 0x00,
            0x2d, 0x00, 0x34, 0x00, 0x2d, 0x00, 0x61, 0x00, 0x6d, 0x00, 0x64, 0x00, 0x36, 0x00, 0x34, 0x00,
            0x00, 0x00, 0x43, 0x00, 0x49, 0x00, 0x46, 0x00, 0x53, 0x00, 0x20, 0x00, 0x56, 0x00, 0x46, 0x00,
            0x53, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6c, 0x00, 0x69, 0x00, 0x65, 0x00, 0x6e, 0x00, 0x74, 0x00,
            0x20, 0x00, 0x66, 0x00, 0x6f, 0x00, 0x72, 0x00, 0x20, 0x00, 0x4c, 0x00, 0x69, 0x00, 0x6e, 0x00,
            0x75, 0x00, 0x78, 0x00, 0x00, 0x00
        },
        .size = 0xe6,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0xe6 - SMB_HEADER_SIZE},
            .command.smb_command = SMB_COM_SESSION_SETUP_ANDX,
            .user = "root",
            .set_values = CIFS_USER,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Session setup andx response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x73, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x47, 0x64, 0x00, 0x02, 0x00,
            0x03, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x37, 0x00, 0x00, 0x55, 0x00, 0x6e, 0x00, 0x69, 0x00,
            0x78, 0x00, 0x00, 0x00, 0x53, 0x00, 0x61, 0x00, 0x6d, 0x00, 0x62, 0x00, 0x61, 0x00, 0x20, 0x00,
            0x33, 0x00, 0x2e, 0x00, 0x35, 0x00, 0x2e, 0x00, 0x36, 0x00, 0x00, 0x00, 0x57, 0x00, 0x4f, 0x00,
            0x52, 0x00, 0x4b, 0x00, 0x47, 0x00, 0x52, 0x00, 0x4f, 0x00, 0x55, 0x00, 0x50, 0x00, 0x00, 0x00
        },
        .size = 0x60,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x60 - SMB_HEADER_SIZE},
            .command.smb_command = SMB_COM_SESSION_SETUP_ANDX,
            .domain = "WORKGROUP",
            .set_values = CIFS_DOMAIN,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Session response with error",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x73, 0x6d, 0x00, 0x00, 0xc0, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x59, 0x00, 0x00, 0x0e, 0x00,
            0x00, 0x00, 0x00
        },
        .size = 0x23,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x23 - SMB_HEADER_SIZE},
            .command.smb_command = SMB_COM_SESSION_SETUP_ANDX,
            .status = SMB_STATUS_LOGON_FAILURE,
        },
    },

    {
        .name = "Trans2 request, query fs info",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x3b, 0x6c, 0x64, 0x00, 0x0f, 0x00,
            0x0f, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x02, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x03, 0x00, 0x03,
            0x00, 0x00, 0x01, 0x02
        },
        .size = 0x44,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x44 - SMB_HEADER_SIZE},
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_TRANS2_SUBCMD,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_QUERY_FS_INFO,
            },
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Trans2 request, query path info",
        .packet = (uint8_t const []) {
//          Start
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xec, 0x1a, 0x64, 0x00, 0x19, 0x00,
            0x0f, 0x28, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x28, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x05, 0x00, 0x29,
//                Padd
            0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2f, 0x00, 0x6c, 0x00, 0x69, 0x00, 0x62, 0x00,
            0x70, 0x00, 0x74, 0x00, 0x68, 0x00, 0x72, 0x00, 0x65, 0x00, 0x61, 0x00, 0x64, 0x00, 0x2e, 0x00,
            0x73, 0x00, 0x6f, 0x00, 0x2e, 0x00, 0x30, 0x00, 0x00, 0x00
        },
        .size = 0x6a,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x6a - SMB_HEADER_SIZE},
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_QUERY_PATH_INFORMATION,
            },
            .path = "/libpthread.so.0",
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Trans2 response, query path info response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x34, 0x00, 0x00, 0xc0, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xec, 0x1a, 0x64, 0x00, 0x19, 0x00,
            0x00, 0x00, 0x00
        },
        .size = 0x23,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x23 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OBJECT_NAME_NOT_FOUND,
        },
    },

    {
        .name = "Trans2 request, find first query",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xec, 0x1a, 0x64, 0x00, 0x1b, 0x00,
            0x0f, 0x12, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x12, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x13,
            0x00, 0x00, 0x17, 0x00, 0x96, 0x00, 0x06, 0x00, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2f, 0x00,
            0x2a, 0x00, 0x00, 0x00
        },
        .size = 0x54,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x54 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_FIND_FIRST2,
            },
            .status = SMB_STATUS_OK,
            .path = "/*",
        },
    },

    {
        .name = "Trans2 request, set_path_info query",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x89, 0x00,
            0x0f, 0x20, 0x00, 0x12, 0x00, 0x02, 0x00, 0xe8, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//                                        ParameterO                                                  Byte
            0x00, 0x00, 0x00, 0x20, 0x00, 0x44, 0x00, 0x12, 0x00, 0x64, 0x00, 0x01, 0x00, 0x06, 0x00, 0x35,
//          Coun  Padding---------  LevelOfInt
            0x00, 0x00, 0x00, 0x00, 0x09, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2f, 0x00, 0x74, 0x00, 0x6d, 0x00,
            0x70, 0x00, 0x2f, 0x00, 0x74, 0x00, 0x65, 0x00, 0x73, 0x00, 0x74, 0x00, 0x2f, 0x00, 0x67, 0x00,
            0x61, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x52, 0x00, 0x00, 0x00, 0xed, 0x01, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x02
        },
        .size = 0x76,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x76 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH | CIFS_LEVEL_OF_INTEREST,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_SET_PATH_INFORMATION,
            },
            .status = SMB_STATUS_OK,
            .flag_file = CIFS_FILE_CREATE,
            .level_of_interest = SMB_POSIX_PATH_OPEN,
            .path = "/tmp/test/ga",
        },
    },

    {
        .name = "Trans2 response, set_path_info response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x89, 0x00,
            0x0a, 0x02, 0x00, 0x70, 0x00, 0x00, 0x00, 0x02, 0x00, 0x38, 0x00, 0x00, 0x00, 0x70, 0x00, 0x3c,
//                                        BC--------  Padd  ErrorOffset Padding---  Flag-Field  FID-------
            0x00, 0x00, 0x00, 0x00, 0x00, 0x75, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x38, 0x18,
//          Create
            0x03, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc7, 0xae, 0x03, 0x2c, 0x00, 0x71, 0xcf, 0x01,
            0xd9, 0x8f, 0x8b, 0x05, 0x00, 0x71, 0xcf, 0x01, 0xc7, 0xae, 0x03, 0x2c, 0x00, 0x71, 0xcf, 0x01,
            0xe3, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0xa5, 0x13, 0xbc, 0x01, 0x00, 0x00, 0x00, 0x00, 0xff, 0x01, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        .size = 0xac,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0xac - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_FID,
            .status = SMB_STATUS_OK,
            .fid = 0x1838,
        },
    },

    {
        .name = "Trans2 request, set_file_info, set eof information",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x8a, 0x00,
            0x0f, 0x06, 0x00, 0x08, 0x00, 0x02, 0x00, 0xe8, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x06, 0x00, 0x44, 0x00, 0x08, 0x00, 0x4a, 0x00, 0x01, 0x00, 0x08, 0x00, 0x11,
            0x00, 0x00, 0x00, 0x00, 0x38, 0x18, 0xfc, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00
        },
        .size = 0x52,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x52 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_FID | CIFS_TRANS2_SUBCMD,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_SET_FILE_INFORMATION,
            },
            .status = SMB_STATUS_OK,
            .fid = 0x1838,
        },
    },

    {
        .name = "Trans2 request, set_file_info, set file unix basic",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x8b, 0x00,
            0x0f, 0x06, 0x00, 0x64, 0x00, 0x02, 0x00, 0xe8, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x06, 0x00, 0x44, 0x00, 0x64, 0x00, 0x4a, 0x00, 0x01, 0x00, 0x08, 0x00, 0x6d,
            0x00, 0x00, 0x00, 0x00, 0x38, 0x18, 0x00, 0x02, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x82, 0xd9, 0xd6, 0x7d, 0x00, 0x71,
            0xcf, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x82, 0xd9, 0xd6, 0x7d, 0x00, 0x71,
            0xcf, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
            0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        .size = 0xae,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0xae - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .set_values = CIFS_FID | CIFS_TRANS2_SUBCMD,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_SET_FILE_INFORMATION,
            },
            .status = SMB_STATUS_OK,
            .fid = 0x1838,
        },
    },

    {
        .name = "Write andx request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x2f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x8c, 0x00,
            0x0e, 0xff, 0x00, 0x00, 0x00, 0x38, 0x18, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00,
            0x74, 0x65, 0x73, 0x74, 0x0a
        },
        .size = 0x45,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x45 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_WRITE_ANDX,
            .set_values = CIFS_FID,
            .status = SMB_STATUS_OK,
            .fid = 0x1838,
            .query_write_bytes = 0x05,
        },
    },

    {
        .name = "Write andx response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x2f, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x8c, 0x00,
            0x06, 0xff, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        .size = 0x2f,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x2f - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_WRITE_ANDX,
            .status = SMB_STATUS_OK,
            .response_write_bytes = 0x05,
        },
    },

    {
        .name = "Close Request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x62, 0x33, 0x64, 0x00, 0x8d, 0x00,
            0x03, 0x38, 0x18, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00
        },
        .size = 0x29,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x29 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_CLOSE,
            .set_values = CIFS_FID,
            .status = SMB_STATUS_OK,
            .fid = 0x1838,
        },
    },

    {
        .name = "Read AnxX Request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x59, 0x1a, 0x64, 0x00, 0x77, 0x00,
            0x0c, 0xff, 0x00, 0x00, 0x00, 0x1a, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        .size = 0x3b,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x3b - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_READ_ANDX,
            .set_values = CIFS_FID,
            .status = SMB_STATUS_OK,
            .fid = 0x191a,
        },
    },

    {
        .name = "Read AnxX Response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x59, 0x1a, 0x64, 0x00, 0x77, 0x00,
            0x0c, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x3b, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x63, 0x6f, 0x6e, 0x74, 0x65,
            0x6e, 0x74, 0x0a
        },
        .size = 0x43,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x43 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_READ_ANDX,
            .status = SMB_STATUS_OK,
            .response_read_bytes = 8,
        },
    },

    {
        .name = "Tree Connect AndX Request",
        .packet = (uint8_t const []) {
            0xff , 0x53 , 0x4d , 0x42 , 0x75 , 0x00 , 0x00 , 0x00 , 0x00 , 0x18 , 0x07 , 0xc8 , 0x00 , 0x00 , 0xda , 0xe3 ,
            0xa6 , 0xab , 0x6e , 0xe7 , 0xb0 , 0x99 , 0x00 , 0x00 , 0x00 , 0x00 , 0xff , 0xfe , 0x01 , 0x38 , 0xc0 , 0x1e ,
            0x04 , 0xff , 0x00 , 0x4a , 0x00 , 0x08 , 0x00 , 0x01 , 0x00 , 0x1f , 0x00 , 0x00 , '\\' , 0x00 , '\\' , 0x00 ,
            'T'  , 0x00 , 'E'  , 0x00 , 'S'  , 0x00 , 'T'  , 0x00 , '\\' , 0x00 , 't'  , 0x00 , 'o'  , 0x00 , 't'  , 0x00 ,
            'o'  , 0x00 , 0x00 , 0x00 , 0x3f , 0x3f , 0x3f , 0x3f , 0x3f , 0x00
        },
        .size = 0x4a,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x4a - SMB_HEADER_SIZE },
            .set_values = CIFS_PATH,
            .command.smb_command = SMB_COM_TREE_CONNECT_ANDX,
            .status = SMB_STATUS_OK,
            .path = "\\\\TEST\\toto",
        },
    },

    {
        .name = "Trans2, Set Path Info, Directory creation, Request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x4a, 0x41, 0x64, 0x00, 0x4a, 0x00,
            0x0f, 0x1c, 0x00, 0x12, 0x00, 0x02, 0x00, 0xe8, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x1c, 0x00, 0x44, 0x00, 0x12, 0x00, 0x60, 0x00, 0x01, 0x00, 0x06, 0x00, 0x31,
            0x00, 0x00, 0x00, 0x00, 0x09, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2f, 0x00, 0x74, 0x00, 0x6d, 0x00,
            0x70, 0x00, 0x2f, 0x00, 0x74, 0x00, 0x65, 0x00, 0x73, 0x00, 0x74, 0x00, 0x32, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x10, 0x02, 0x00, 0x00, 0xed, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x02
        },
        .size = 0x72,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x72 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OK,
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH | CIFS_LEVEL_OF_INTEREST,
            .flag_file = CIFS_FILE_CREATE | CIFS_FILE_DIRECTORY,
            .level_of_interest = SMB_POSIX_PATH_OPEN,
            .path = "/tmp/test2",
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_SET_PATH_INFORMATION,
            },
        },
    },

    {
        .name = "Trans2, Set Path Info, Directory deletion, Request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x2c, 0x51, 0x64, 0x00, 0xa6, 0x00,
            0x0f, 0x1a, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x1a, 0x00, 0x44, 0x00, 0x02, 0x00, 0x5e, 0x00, 0x01, 0x00, 0x06, 0x00, 0x1f,
            0x00, 0x00, 0x00, 0x00, 0x0a, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2f, 0x00, 0x74, 0x00, 0x6d, 0x00,
            0x70, 0x00, 0x2f, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        .size = 0x60,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x60 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OK,
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH | CIFS_LEVEL_OF_INTEREST,
            .flag_file = CIFS_FILE_UNLINK,
            .level_of_interest = SMB_POSIX_PATH_UNLINK,
            .path = "/tmp/toto",
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_SET_PATH_INFORMATION,
            },
        },
    },

    {
        .name = "Com delete directory, Query",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xdb, 0x4f, 0x64, 0x00, 0x82, 0x00,
            0x00, 0x17, 0x00, 0x04, 0x2f, 0x00, 0x74, 0x00, 0x6d, 0x00, 0x70, 0x00, 0x2f, 0x00, 0x74, 0x00,
            0x65, 0x00, 0x73, 0x00, 0x74, 0x00, 0x32, 0x00, 0x00, 0x00
        },
        .size = 0x3a,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x3a - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_DELETE_DIRECTORY,
            .status = SMB_STATUS_OK,
            .set_values = CIFS_PATH,
            .path = "/tmp/test2",
        },
    },

    {
        .name = "Com delete, Query Path Info, inexistant file, Response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x34, 0x00, 0x00, 0xc0, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xa2, 0x5a, 0x64, 0x00, 0xec, 0x00,
            0x00, 0x00, 0x00
        },
        .size = 0x23,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x23 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OBJECT_NAME_NOT_FOUND,
        },
    },

    {
        .name = "Create file with path - request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0xa2, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x88, 0x68, 0x0b, 0x01, 0x38, 0x86, 0x08,
            0x18, 0xff, 0x00, 0xde, 0xde, 0x00, 0x54, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x80, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x07, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
            0x03, 0x57, 0x00, 0x00, 0x5c, 0x00, 0x54, 0x00, 0x4f, 0x00, 0x54, 0x00, 0x52, 0x00, 0x6f, 0x00,
            0x6f, 0x00, 0x74, 0x00, 0x52, 0x00, 0x5f, 0x00, 0x53, 0x00, 0x6d, 0x00, 0x55, 0x00, 0x72, 0x00,
            0x61, 0x00, 0x6e, 0x00, 0x69, 0x00, 0x70, 0x00, 0x5c, 0x00, 0x44, 0x00, 0x4e, 0x00, 0x42, 0x00,
            0x4f, 0x00, 0x58, 0x00, 0x5c, 0x00, 0x4e, 0x00, 0x5e, 0x00, 0x43, 0x00, 0x5c, 0x00, 0x5f, 0x00,
            0x52, 0x00, 0x45, 0x00, 0x53, 0x00, 0x55, 0x00, 0x4c, 0x00, 0x54, 0x00, 0x41, 0x00, 0x54, 0x00,
            0x2e, 0x00, 0x43, 0x00, 0x53, 0x00, 0x56, 0x00, 0x00, 0x00, 0x0a
        },
        .size = 0xaa,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0xaa - SMB_HEADER_SIZE },
            .path = "\\TOTRootR_SmUranip\\DNBOX\\N^C\\_RESULTAT.CSV",
            .set_values = CIFS_PATH,
            .command.smb_command = SMB_COM_NT_CREATE_ANDX,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Create file with path - response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0xa2, 0x00, 0x00, 0x00, 0x00, 0x98, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x88, 0x68, 0x0b, 0x01, 0x38, 0x86, 0x08,
            0x2a, 0xff, 0x00, 0x87, 0x00, 0x00, 0x07, 0x80, 0x01, 0x00, 0x00, 0x00, 0x05, 0xa2, 0x9e, 0xbb,
            0x6a, 0x94, 0xcf, 0x01, 0xbe, 0x12, 0xe7, 0xe1, 0x6b, 0x94, 0xcf, 0x01, 0xc3, 0x39, 0xee, 0xe1,
            0x6b, 0x94, 0xcf, 0x01, 0xc3, 0x39, 0xee, 0xe1, 0x6b, 0x94, 0xcf, 0x01, 0x20, 0x00, 0x00, 0x00,
            0xd8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd5, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x01, 0x1f,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        .size = 0x87,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x87 - SMB_HEADER_SIZE },
            .fid = 0x8007,
            .set_values = CIFS_FID,
            .command.smb_command = SMB_COM_NT_CREATE_ANDX,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Trans2 Request, Query file info, file internal info",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x4a, 0x53,
            0x91, 0xd1, 0xdd, 0x2e, 0xad, 0xa0, 0x00, 0x00, 0x08, 0x08, 0x74, 0x0e, 0x02, 0xf0, 0x87, 0x0c,
//          Wc--  Tot param-  Total data  Max param-  max data--  MaxS  Rese
            0x0f, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//                                                                                        SubCommand  Byte
            0x00, 0x00, 0x00, 0x04, 0x00, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x07, 0x00, 0x07,
//          Count Padding---------  Fid-------  Level of i
            0x00, 0x00, 0x00, 0x00, 0x12, 0x80, 0xee, 0x03
        },
        .size = 0x48,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x48 - SMB_HEADER_SIZE },
            .fid = 0x8012,
            .set_values = CIFS_FID | CIFS_TRANS2_SUBCMD | CIFS_LEVEL_OF_INTEREST,
            .command.smb_command = SMB_COM_TRANSACTION2,
            .subcommand.trans2_subcmd = SMB_TRANS2_QUERY_FILE_INFORMATION,
            .level_of_interest = PASS_THROUGH_LEVEL_OF_INTEREST | FILE_INTERNAL_INFORMATION,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Trans2 Response, Query file info, file internal info",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x98, 0x07, 0xc8, 0x00, 0x00, 0x6f, 0xf1,
            0xe4, 0x63, 0xa3, 0x56, 0x6b, 0xc0, 0x00, 0x00, 0x08, 0x08, 0x74, 0x0e, 0x02, 0xf0, 0x87, 0x0c,
            0x0a, 0x02, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00, 0x38, 0x00, 0x00, 0x00, 0x08, 0x00, 0x3c,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2f, 0xcb, 0x17, 0x00,
            0x00, 0x00, 0x14, 0x00
        },
        .size = 0x44,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x44 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Trans2 Response, Query file info, File standard info",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x98, 0x07, 0xc8, 0x00, 0x00, 0x2c, 0xb0,
            0xb5, 0x06, 0xb1, 0x57, 0x78, 0xc8, 0x00, 0x00, 0x08, 0x08, 0x74, 0x0e, 0x02, 0xf0, 0xc7, 0x0c,
            0x0a, 0x02, 0x00, 0x18, 0x00, 0x00, 0x00, 0x02, 0x00, 0x38, 0x00, 0x00, 0x00, 0x18, 0x00, 0x3c,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
            0x00, 0x01, 0x00, 0x00
        },
        .size = 0x54,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x54 - SMB_HEADER_SIZE },
            .command.smb_command = SMB_COM_TRANSACTION2,
            .subcommand.trans2_subcmd = SMB_TRANS2_QUERY_FILE_INFORMATION,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Smb2, read request",
        .packet = (uint8_t const []) {
            0xfe, 0x53, 0x4d, 0x42, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0xe0, 0x1e,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x05, 0xec, 0x00, 0x00, 0x9e, 0xa1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x31, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0xa0, 0x3e, 0x7d, 0x17, 0x45, 0xf8, 0x7d, 0x67, 0xa0, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00
        },
        .size = 0x71,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB2_HEADER_SIZE, .payload = 0x71 - SMB2_HEADER_SIZE },
            .set_values = CIFS_FID,
            .command.smb2_command = SMB2_COM_READ,
            .status = SMB_STATUS_OK,
            .fid = 0x677df845177d3ea0,
        },
    },

    {
        .name = "Smb2, read response",
        .packet = (uint8_t const []) {
            0xfe, 0x53, 0x4d, 0x42, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x21, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x05, 0xec, 0x00, 0x00, 0x9e, 0xa1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x11, 0x00, 0x50, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x67, 0x72, 0x61, 0x0a
        },
        .size = 0x54,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB2_HEADER_SIZE, .payload = 0x54 - SMB2_HEADER_SIZE },
            .command.smb2_command = SMB2_COM_READ,
            .status = SMB_STATUS_OK,
            .response_read_bytes = 4,
        }
    },

    {
        .name = "Get Referral - request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x98, 0x35,
            0xd3, 0x41, 0x85, 0x12, 0x50, 0x39, 0x00, 0x00, 0x06, 0x10, 0x68, 0x05, 0x01, 0x20, 0xc0, 0x00,
            0x0f, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x24, 0x00, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x10, 0x00, 0x27,
            0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x61, 0x00, 0x62, 0x00, 0x63, 0x00, 0x64, 0x00, 0x74, 0x00,
            0x65, 0x00, 0x73, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6e, 0x00, 0x67, 0x00, 0x74, 0x00, 0x2e, 0x00,
            0x63, 0x00, 0x6f, 0x00, 0x6d, 0x00, 0x00, 0x00
        },
        .size = 0x68,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x68 - SMB_HEADER_SIZE },
            .path = "abcdtestingt.com",
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH,
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OK,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_GET_DFS_REFERRAL,
            },
        },
    },

    {
        .name = "Find Next2 - request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x32, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x98, 0xcb,
            0x55, 0x0a, 0x44, 0xda, 0xc2, 0xba, 0x00, 0x00, 0x07, 0x00, 0x34, 0x10, 0x02, 0xe8, 0x44, 0xe2,
            0x0f, 0x3e, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x3e, 0x00, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x00, 0x41,
            0x00, 0x00, 0x00, 0x00, 0x05, 0x18, 0x56, 0x05, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00,
            0x41, 0x00, 0x44, 0x00, 0x5f, 0x00, 0x31, 0x00, 0x33, 0x00, 0x54, 0x00, 0x46, 0x00, 0x31, 0x00,
            0x32, 0x00, 0x43, 0x00, 0x5f, 0x00, 0x50, 0x00, 0x52, 0x00, 0x54, 0x00, 0x32, 0x00, 0x32, 0x00,
            0x32, 0x00, 0x46, 0x00, 0x46, 0x00, 0x46, 0x00, 0x2e, 0x00, 0x54, 0x00, 0x58, 0x00, 0x54, 0x00,
            0x00, 0x00
        },
        .size = 0x82,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x82 - SMB_HEADER_SIZE },
            .path = "AD_13TF12C_PRT222FFF.TXT",
            .set_values = CIFS_TRANS2_SUBCMD | CIFS_PATH,
            .command.smb_command = SMB_COM_TRANSACTION2,
            .status = SMB_STATUS_OK,
            .subcommand = {
                .trans2_subcmd = SMB_TRANS2_FIND_NEXT2,
            },
        },
    },

    {

        .name = "Smb2, Session setup request, NTLMSSP_NEGOCIATE",
        .packet = (uint8_t const []) {
            0xfe, 0x53, 0x4d, 0x42, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x20,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x19, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x00, 0x53, 0x00,
//                                                          Start buff              1 3   6     1     5
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x51, 0x06, 0x06, 0x2b, 0x06, 0x01, 0x05,
//          5     2
            0x05, 0x02, 0xa0, 0x47, 0x30, 0x45, 0xa0, 0x0e, 0x30, 0x0c, 0x06, 0x0a, 0x2b, 0x06, 0x01, 0x04,
            0x01, 0x82, 0x37, 0x02, 0x02, 0x0a, 0xa2, 0x33, 0x04, 0x31, 0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53,
            0x50, 0x00, 0x01, 0x00, 0x00, 0x00, 0x15, 0x82, 0x08, 0x60, 0x09, 0x00, 0x09, 0x00, 0x20, 0x00,
            0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x29, 0x00, 0x00, 0x00, 0x57, 0x4f, 0x52, 0x4b, 0x47, 0x52,
            0x4f, 0x55, 0x50, 0x43, 0x43, 0x45, 0x4c, 0x4c, 0x49, 0x45, 0x52
        },
        .size = 0xab,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB2_HEADER_SIZE, .payload = 0xab - SMB2_HEADER_SIZE },
            .command.smb2_command = SMB2_COM_SESSION_SETUP,
        }
    },

    {
        .name = "Flush - request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x05, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x20, 0xff, 0xfe, 0x01, 0x38, 0x00, 0xaa,
            0x01, 0x0f, 0x00, 0x00, 0x00
        },
        .size = 0x25,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x25 - SMB_HEADER_SIZE },
            .fid = 0x000f,
            .set_values = CIFS_FID,
            .command.smb_command = SMB_COM_FLUSH,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Smb2, Session setup request, NTLMSSP_AUTH",
        .packet = (uint8_t const []) {
            0xfe, 0x53, 0x4d, 0x42, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x20,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9e, 0xa1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x19, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x00, 0x24, 0x01,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa1, 0x82, 0x01, 0x20, 0x30, 0x82, 0x01, 0x1c,
            0xa2, 0x82, 0x01, 0x18, 0x04, 0x82, 0x01, 0x14, 0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53, 0x50, 0x00,
            0x03, 0x00, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x40, 0x00, 0x00, 0x00, 0x82, 0x00, 0x82, 0x00,
            0x58, 0x00, 0x00, 0x00, 0x12, 0x00, 0x12, 0x00, 0xda, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00,
            0xec, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00, 0xf4, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00,
            0x04, 0x01, 0x00, 0x00, 0x15, 0x82, 0x08, 0x60, 0x4a, 0x80, 0x60, 0x9e, 0x50, 0x1e, 0x6b, 0x56,
            0x41, 0xa8, 0xcd, 0x5e, 0x63, 0x37, 0xc9, 0x82, 0x37, 0x6b, 0x65, 0x72, 0x2f, 0xc8, 0x32, 0x79,
            0xe6, 0x41, 0xbb, 0xb5, 0x17, 0x46, 0x08, 0x20, 0xb6, 0x90, 0x1b, 0x69, 0x31, 0x4a, 0x2d, 0x64,
            0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x19, 0x48, 0x3e, 0x82, 0x9b, 0xcf, 0x01,
            0xb2, 0xb5, 0xc0, 0x05, 0xd6, 0x32, 0xf0, 0x86, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x16, 0x00,
            0x52, 0x00, 0x41, 0x00, 0x43, 0x00, 0x4b, 0x00, 0x53, 0x00, 0x54, 0x00, 0x41, 0x00, 0x54, 0x00,
            0x49, 0x00, 0x4f, 0x00, 0x4e, 0x00, 0x01, 0x00, 0x16, 0x00, 0x52, 0x00, 0x41, 0x00, 0x43, 0x00,
            0x4b, 0x00, 0x53, 0x00, 0x54, 0x00, 0x41, 0x00, 0x54, 0x00, 0x49, 0x00, 0x4f, 0x00, 0x4e, 0x00,
            0x04, 0x00, 0x00, 0x00, 0x03, 0x00, 0x16, 0x00, 0x52, 0x00, 0x61, 0x00, 0x63, 0x00, 0x6b, 0x00,
            0x53, 0x00, 0x74, 0x00, 0x61, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6f, 0x00, 0x6e, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x57, 0x00, 0x4f, 0x00, 0x52, 0x00, 0x4b, 0x00, 0x47, 0x00, 0x52, 0x00, 0x4f, 0x00,
            0x55, 0x00, 0x50, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x43, 0x00, 0x43, 0x00,
            0x45, 0x00, 0x4c, 0x00, 0x4c, 0x00, 0x49, 0x00, 0x45, 0x00, 0x52, 0x00, 0x63, 0x18, 0x6a, 0x83,
            0x88, 0x44, 0xe6, 0x07, 0xab, 0xac, 0x16, 0x70, 0x91, 0x97, 0xaa, 0x9e
        },
        .size = 0x17c,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB2_HEADER_SIZE, .payload = 0x17c - SMB2_HEADER_SIZE },
            .command.smb2_command = SMB2_COM_SESSION_SETUP,
            // TODO Fetch domain and user
            /*.set_values = CIFS_DOMAIN | CIFS_USER,*/
            .user = "toto",
            .domain = "WORKGROUP",
        }
    },

    {
        .name = "Rename - request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x07, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xd0, 0xff, 0xfe, 0x03, 0x48, 0x00, 0x94,
            0x01, 0x16, 0x00, 0xe3, 0x00, 0x04, 0x5c, 0x00, 0x61, 0x00, 0x61, 0x00, 0x61, 0x00, 0x61, 0x00,
            0x61, 0x00, 0x61, 0x00, 0x49, 0x00, 0x53, 0x00, 0x44, 0x00, 0x49, 0x00, 0x52, 0x00, 0x5f, 0x00,
            0x54, 0x00, 0x5c, 0x00, 0x4c, 0x00, 0x65, 0x00, 0x44, 0x00, 0x49, 0x00, 0x52, 0x00, 0x75, 0x00,
            0x5c, 0x00, 0x2e, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00,
            0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x33, 0x00, 0x30, 0x00, 0x5c, 0x00, 0x54, 0x00, 0x6d, 0x00,
            0x70, 0x00, 0x44, 0x00, 0x61, 0x00, 0x74, 0x00, 0x61, 0x00, 0x5c, 0x00, 0x31, 0x00, 0x31, 0x00,
            0x31, 0x00, 0x31, 0x00, 0x31, 0x00, 0x31, 0x00, 0x39, 0x00, 0x39, 0x00, 0x2e, 0x00, 0x74, 0x00,
            0x78, 0x00, 0x74, 0x00, 0x00, 0x00, 0x04, 0x00, 0x5c, 0x00, 0x46, 0x00, 0x6f, 0x00, 0x72, 0x00,
            0x6d, 0x00, 0x49, 0x00, 0x52, 0x00, 0x49, 0x00, 0x53, 0x00, 0x49, 0x00, 0x44, 0x00, 0x53, 0x00,
            0x5f, 0x00, 0x54, 0x00, 0x5c, 0x00, 0x4c, 0x00, 0x65, 0x00, 0x63, 0x00, 0x74, 0x00, 0x65, 0x00,
            0x75, 0x00, 0x72, 0x00, 0x2e, 0x00, 0x30, 0x00, 0x32, 0x00, 0x5c, 0x00, 0x32, 0x00, 0x30, 0x00,
            0x31, 0x00, 0x34, 0x00, 0x30, 0x00, 0x36, 0x00, 0x33, 0x00, 0x30, 0x00, 0x5c, 0x00, 0x44, 0x00,
            0x61, 0x00, 0x74, 0x00, 0x61, 0x00, 0x5c, 0x00, 0x30, 0x00, 0x31, 0x00, 0x5c, 0x00, 0x30, 0x00,
            0x31, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x38, 0x00, 0x39, 0x00, 0x39, 0x00, 0x2e, 0x00,
            0x74, 0x00, 0x78, 0x00, 0x74, 0x00, 0x00, 0x00
        },
        .size = 0x108,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x108 - SMB_HEADER_SIZE },
            .path = "\\aaaaaaISDIR_T\\LeDIRu\\.00000000030\\TmpData\\11111199.txt",
            .set_values = CIFS_PATH,
            .command.smb_command = SMB_COM_RENAME,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Locking AndX - request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x24, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0xff, 0xfe, 0x01, 0x90, 0x0d, 0x14,
            0x08, 0xff, 0x00, 0xde, 0xde, 0x7e, 0x40, 0x10, 0x00, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00,
            0x00, 0x14, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x59, 0xff, 0xff, 0x7f, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
        },
        .size = 0x47,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x47 - SMB_HEADER_SIZE },
            .fid = 0x407e,
            .set_values = CIFS_FID,
            .command.smb_command = SMB_COM_LOCKING_ANDX,
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "NT Transact (SMB_NT_TRANSACT_NOTIFY_CHANGE) -  request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x70, 0x0e, 0x01, 0x90, 0x48, 0x78,
            0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x00, 0x03, 0x00, 0x00, 0x00, 0xd7, 0x80, 0x01, 0x00, 0x03,
            0x00, 0x00, 0x00, 0x00
        },
        .size = 0x54,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x54 - SMB_HEADER_SIZE },
            .fid = 0x80d7,
            .set_values = CIFS_NT_TRANSACT_SUBCMD | CIFS_FID,
            .command.smb_command = SMB_COM_NT_TRANSACT,
            .subcommand = {
                .nt_transact_subcmd = SMB_NT_TRANSACT_NOTIFY_CHANGE,
            },
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "NT Transact (SMB_NT_TRANSACT_IOCTL) -  request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x20, 0x94, 0x04, 0x01, 0x38, 0x40, 0x51,
            0x17, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x54, 0x00, 0x00, 0x00, 0x04, 0x02, 0x00, 0xc0, 0x00, 0x09, 0x00, 0x10, 0x80, 0x01, 0x00, 0x03,
            0x00, 0x00, 0x00, 0x00
   },
        .size = 0x54,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x54 - SMB_HEADER_SIZE },
            .fid = 0x8010,
            .set_values = CIFS_NT_TRANSACT_SUBCMD | CIFS_FID,
            .command.smb_command = SMB_COM_NT_TRANSACT,
            .subcommand = {
                .nt_transact_subcmd = SMB_NT_TRANSACT_IOCTL,
            },
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "NT Transact (SMB_NT_TRANSACT_QUERY_SECURITY_DESC) -  request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x20, 0x94, 0x04, 0x01, 0x38, 0x80, 0xf2,
            0x13, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
            0x00, 0x10, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x54, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x40, 0x00, 0x00,
            0x07, 0x00, 0x00, 0x00
   },
        .size = 0x54,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x54 - SMB_HEADER_SIZE },
            .fid = 0x400e,
            .set_values = CIFS_NT_TRANSACT_SUBCMD | CIFS_FID,
            .command.smb_command = SMB_COM_NT_TRANSACT,
            .subcommand = {
                .nt_transact_subcmd = SMB_NT_TRANSACT_QUERY_SECURITY_DESC,
            },
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "NT Transact (SMB_NT_TRANSACT_CREATE) -  request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x08, 0x03, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x43, 0x79, 0x00, 0x08, 0x3d, 0x01,
            0x13, 0x00, 0x00, 0x00, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x65, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x74, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0xff, 0x01, 0x1f, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x5c, 0x00, 0x72, 0x00, 0x61, 0x00, 0x77, 0x00, 0x6f, 0x00, 0x70, 0x00, 0x65, 0x00,
            0x6e, 0x00, 0x5c, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x72, 0x00, 0x74, 0x00, 0x75, 0x00, 0x72, 0x00,
            0x65, 0x00, 0x5f, 0x00, 0x6e, 0x00, 0x74, 0x00, 0x63, 0x00, 0x72, 0x00, 0x65, 0x00, 0x61, 0x00,
            0x74, 0x00, 0x65, 0x00, 0x78, 0x00, 0x2e, 0x00, 0x74, 0x00, 0x78, 0x00, 0x74, 0x00, 0x00, 0x00
   },
        .size = 0xc0,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0xc0 - SMB_HEADER_SIZE },
            .set_values = CIFS_NT_TRANSACT_SUBCMD | CIFS_PATH,
            .path = "\\rawopen\\torture_ntcreatex.txt",
            .command.smb_command = SMB_COM_NT_TRANSACT,
            .subcommand = {
                .nt_transact_subcmd = SMB_NT_TRANSACT_CREATE,
            },
            .status = SMB_STATUS_OK,
        },
    },


    {
        .name = "Transaction (SMB_TRANS_WAIT_NMPIPE) -  request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x25, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x90, 0x68, 0x0b, 0x01, 0x38, 0x01, 0x14,
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x53, 0x00, 0x00,
            0x00, 0x21, 0x00, 0x00, 0x5c, 0x00, 0x50, 0x00, 0x49, 0x00, 0x50, 0x00, 0x45, 0x00, 0x5c, 0x00,
            0x4d, 0x00, 0x73, 0x00, 0x46, 0x00, 0x74, 0x00, 0x65, 0x00, 0x57, 0x00, 0x64, 0x00, 0x73, 0x00,
            0x00, 0x00, 0x00, 0x00
   },
        .size = 0x64,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x64 - SMB_HEADER_SIZE },
            .path = "\\PIPE\\MsFteWds",
            .set_values = CIFS_TRANSACTION_SUBCMD | CIFS_PATH,
            .command.smb_command = SMB_COM_TRANSACTION,
            .subcommand = {
                .transaction_subcmd = SMB_TRANS_WAIT_NMPIPE,
            },
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Transaction (SMB_TRANS_TRANSACT_NMPIPE) -  request",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x25, 0x00, 0x00, 0x00, 0x00, 0x18, 0x07, 0xc8, 0x00, 0x00, 0x42, 0x31,
            0x9f, 0xa2, 0xd7, 0x94, 0x7f, 0x58, 0x00, 0x00, 0x00, 0x08, 0x30, 0x16, 0x00, 0x08, 0x80, 0x1d,
            0x10, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x00, 0x60, 0x00, 0x54, 0x00, 0x02, 0x00, 0x26, 0x00, 0x00,
            0x80, 0x71, 0x00, 0x00, 0x5c, 0x00, 0x50, 0x00, 0x49, 0x00, 0x50, 0x00, 0x45, 0x00, 0x5c, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x03, 0x10, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x02, 0x00,
            0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x4b, 0x00, 0x41, 0x00,
            0x54, 0x00, 0x41, 0x00, 0x41, 0x00, 0x4e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x04, 0x00, 0x02, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x08, 0x00, 0x02, 0x00,
            0x00, 0x00, 0x00, 0x00
   },
        .size = 0xb4,
        .ret = PROTO_OK,
        .way = FROM_CLIENT,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0xb4 - SMB_HEADER_SIZE },
            .fid = 0x8000,
            .set_values = CIFS_TRANSACTION_SUBCMD | CIFS_FID,
            .command.smb_command = SMB_COM_TRANSACTION,
            .subcommand = {
                .transaction_subcmd = SMB_TRANS_TRANSACT_NMPIPE,
            },
            .status = SMB_STATUS_OK,
        },
    },

    {
        .name = "Session setup AndX response",
        .packet = (uint8_t const []) {
            0xff, 0x53, 0x4d, 0x42, 0x73, 0x00, 0x00, 0x00, 0x00, 0x88, 0x01, 0xc8, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xca, 0x6b, 0x00, 0x08, 0x02, 0x00,
            0x03, 0xff, 0x00, 0x87, 0x00, 0x00, 0x00, 0x5e, 0x00, 0x11, 0x57, 0x00, 0x69, 0x00, 0x6e, 0x00,
            0x64, 0x00, 0x6f, 0x00, 0x77, 0x00, 0x73, 0x00, 0x20, 0x00, 0x38, 0x00, 0x20, 0x00, 0x50, 0x00,
            0x72, 0x00, 0x6f, 0x00, 0x20, 0x00, 0x39, 0x00, 0x32, 0x00, 0x30, 0x00, 0x30, 0x00, 0x00, 0x00,
            0x57, 0x00, 0x69, 0x00, 0x6e, 0x00, 0x64, 0x00, 0x6f, 0x00, 0x77, 0x00, 0x73, 0x00, 0x20, 0x00,
            0x38, 0x00, 0x20, 0x00, 0x50, 0x00, 0x72, 0x00, 0x6f, 0x00, 0x20, 0x00, 0x36, 0x00, 0x2e, 0x00,
            0x32, 0x00, 0x00, 0x00, 0x57, 0x00, 0x4f, 0x00, 0x52, 0x00, 0x4b, 0x00, 0x47, 0x00, 0x52, 0x00,
            0x4f, 0x00, 0x55, 0x00, 0x50, 0x00, 0x00
        },
        .size = 0x87,
        .ret = PROTO_OK,
        .way = FROM_SERVER,
        .expected = {
            .info = { .head_len = SMB_HEADER_SIZE, .payload = 0x87 - SMB_HEADER_SIZE },
            .set_values = CIFS_DOMAIN,
            .command.smb_command = SMB_COM_SESSION_SETUP_ANDX,
            .status = SMB_STATUS_OK,
            .domain = "WORKGROUP",
        },
    },

};

#define CHECK_SMB_SET(INFO, EXPECTED, MASK) \
    check_set_values(INFO->set_values, EXPECTED->set_values, MASK, #MASK);

static unsigned cur_test;


#define CHECK_FLAG_FILE(INFO, EXPECTED, MASK) \
    check_set_values(INFO->flag_file, EXPECTED->flag_file, MASK, #MASK);

static int compare_expected_cifs(struct cifs_proto_info const *const info,
        struct cifs_proto_info const *const expected)
{
    CHECK_INT(info->info.head_len, expected->info.head_len);
    CHECK_INT(info->info.payload, expected->info.payload);

    CHECK_SET_VALUE(info, expected, CIFS_DOMAIN);
    CHECK_SET_VALUE(info, expected, CIFS_USER);
    CHECK_SET_VALUE(info, expected, CIFS_PATH);
    CHECK_SET_VALUE(info, expected, CIFS_TRANS2_SUBCMD);
    CHECK_SET_VALUE(info, expected, CIFS_LEVEL_OF_INTEREST);
    CHECK_SET_VALUE(info, expected, CIFS_FID);

    CHECK_INT(info->status, expected->status);
    CHECK_INT(info->command.smb_command, expected->command.smb_command);
    CHECK_INT(info->query_write_bytes, expected->query_write_bytes);
    CHECK_INT(info->response_read_bytes,  expected->response_read_bytes);
    CHECK_INT(info->response_write_bytes, expected->response_write_bytes);
    if (VALUES_ARE_SET(info, CIFS_DOMAIN))
        CHECK_STR(info->domain, expected->domain);
    if (VALUES_ARE_SET(info, CIFS_USER))
        CHECK_STR(info->user, expected->user);
    if (VALUES_ARE_SET(info, CIFS_PATH))
        CHECK_STR(info->path, expected->path);
    if (VALUES_ARE_SET(info, CIFS_TRANS2_SUBCMD))
        CHECK_INT(info->subcommand.trans2_subcmd, expected->subcommand.trans2_subcmd);
    if (VALUES_ARE_SET(info, CIFS_TRANSACTION_SUBCMD))
        CHECK_INT(info->subcommand.transaction_subcmd, expected->subcommand.transaction_subcmd);
    if (VALUES_ARE_SET(info, CIFS_NT_TRANSACT_SUBCMD))
        CHECK_INT(info->subcommand.nt_transact_subcmd, expected->subcommand.nt_transact_subcmd);
    if (VALUES_ARE_SET(info, CIFS_LEVEL_OF_INTEREST))
        CHECK_INT(info->level_of_interest, expected->level_of_interest);
    if (VALUES_ARE_SET(info, CIFS_FID))
        CHECK_BIG_INT(info->fid, expected->fid);

    CHECK_FLAG_FILE(info, expected, CIFS_FILE_CREATE);
    CHECK_FLAG_FILE(info, expected, CIFS_FILE_DIRECTORY);
    CHECK_FLAG_FILE(info, expected, CIFS_FILE_UNLINK);

    return 0;
}

static unsigned called = 0;
static void cifs_info_check(struct proto_subscriber unused_ *s, struct proto_info const *info_,
        size_t unused_ cap_len, uint8_t const unused_ *packet, struct timeval const unused_ *now)
{
    // Check info against parse_tests[cur_test].expected
    struct cifs_proto_info const *const info = DOWNCAST(info_, info, cifs_proto_info);
    struct cifs_proto_info const *const expected = &parse_tests[cur_test].expected;
    assert(0 == compare_expected_cifs(info, expected));
    called++;
}

static void parse_check(void)
{
    struct timeval now;
    timeval_set_now(&now);
    struct parser *parser = proto_cifs->ops->parser_new(proto_cifs);
    struct proto_subscriber sub;
    hook_subscriber_ctor(&pkt_hook, &sub, cifs_info_check);

    for (cur_test = 0; cur_test < NB_ELEMS(parse_tests); cur_test++) {
        struct parse_test const *test = parse_tests + cur_test;
        printf("Check packet %d '%s' of size 0x%x (%d)\n", cur_test, test->name, test->size, test->size);
        enum proto_parse_status ret = cifs_parse(parser, NULL, test->way, test->packet, test->size,
                test->size, &now, test->size, test->packet);
        assert(ret == test->ret);
        assert(called == cur_test + 1);
    }
    hook_subscriber_dtor(&pkt_hook, &sub);
}

static void compute_padding_check()
{
    struct cursor cursor = {.cap_len = 0x37 };
    assert(1 == compute_padding(&cursor, 0, 2));
    assert(0 == compute_padding(&cursor, 1, 2));
    assert(3 == compute_padding(&cursor, 0, 4));
}

int main(void)
{
    log_init();
    ext_init();
    mutex_init();
    objalloc_init();
    proto_init();
    pkt_wait_list_init();
    ref_init();
    cap_init();
    eth_init();
    ip_init();
    ip6_init();
    tcp_init();
    cifs_init();
    log_set_level(LOG_DEBUG, NULL);
    log_set_level(LOG_WARNING, "mutex");
    log_set_file("cifs_check.log");

    compute_padding_check();
    parse_check();

    cifs_fini();
    tcp_fini();
    ip6_fini();
    ip_fini();
    eth_fini();
    cap_fini();
    ref_fini();
    pkt_wait_list_fini();
    proto_fini();
    objalloc_fini();
    mutex_fini();
    ext_fini();
    log_fini();
    return EXIT_SUCCESS;
}

